<!DOCTYPE html>
<html lang="" xml:lang="">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>7 Altering the rendering process | Creating the litr R package</title>
<meta name="description" content="7 Altering the rendering process | Creating the litr R package">
<meta name="generator" content="bookdown 0.40 and GitBook 2.6.7">
<meta property="og:title" content="7 Altering the rendering process | Creating the litr R package">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="7 Altering the rendering process | Creating the litr R package">
<meta name="author" content="Jacob Bien">
<meta name="date" content="2022-05-27">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="prev" href="document.html">
<link rel="next" href="functionality-to-facilitate-workflow.html">
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script><link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet">
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet">
<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet">
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet">
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script><style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>
<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}
    legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}
    </style>
</head>
<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation"><ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Preamble</a></li>
<li class="chapter" data-level="2" data-path="overview.html"><a href="overview.html"><i class="fa fa-check"></i><b>2</b> Overview</a></li>
<li class="chapter" data-level="3" data-path="package-setup.html">
<a href="package-setup.html"><i class="fa fa-check"></i><b>3</b> Package setup</a>
<ul>
<li class="chapter" data-level="3.1" data-path="package-setup.html"><a href="package-setup.html#a-note-on-circularity"><i class="fa fa-check"></i><b>3.1</b> A note on circularity</a></li>
</ul>
</li>
<li class="chapter" data-level="4" data-path="generating-package.html">
<a href="generating-package.html"><i class="fa fa-check"></i><b>4</b> Generating the R package</a>
<ul>
<li class="chapter" data-level="4.1" data-path="generating-package.html"><a href="generating-package.html#sending-code-chunks-to-the-package"><i class="fa fa-check"></i><b>4.1</b> Sending code chunks to the package</a></li>
<li class="chapter" data-level="4.2" data-path="generating-package.html"><a href="generating-package.html#setting-up-the-r-package-creation"><i class="fa fa-check"></i><b>4.2</b> Setting up the R package creation</a></li>
</ul>
</li>
<li class="chapter" data-level="5" data-path="hash.html"><a href="hash.html"><i class="fa fa-check"></i><b>5</b> Not overwriting a manually edited R package</a></li>
<li class="chapter" data-level="6" data-path="document.html"><a href="document.html"><i class="fa fa-check"></i><b>6</b> Wrapper to <code>devtools::document()</code></a></li>
<li class="chapter" data-level="7" data-path="rendering.html">
<a href="rendering.html"><i class="fa fa-check"></i><b>7</b> Altering the rendering process</a>
<ul>
<li class="chapter" data-level="7.1" data-path="hash.html">
<a href="hash.html#output-format"><i class="fa fa-check"></i><b>7.1</b> Defining <code>litr</code> output formats</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="rendering.html"><a href="rendering.html#pdf-output-format"><i class="fa fa-check"></i><b>7.1.1</b> .pdf output format</a></li>
<li class="chapter" data-level="7.1.2" data-path="rendering.html"><a href="rendering.html#html-output-format"><i class="fa fa-check"></i><b>7.1.2</b> .html output format</a></li>
<li class="chapter" data-level="7.1.3" data-path="rendering.html"><a href="rendering.html#bookdown-output-format"><i class="fa fa-check"></i><b>7.1.3</b> bookdown output format</a></li>
</ul>
</li>
<li class="chapter" data-level="7.2" data-path="rendering.html"><a href="rendering.html#render"><i class="fa fa-check"></i><b>7.2</b> Defining <code>litr::<a href="rendering.html#render">render</a>()</code></a></li>
</ul>
</li>
<li class="chapter" data-level="8" data-path="functionality-to-facilitate-workflow.html"><a href="functionality-to-facilitate-workflow.html"><i class="fa fa-check"></i><b>8</b> Functionality to facilitate workflow</a></li>
<li class="chapter" data-level="9" data-path="adding-extras-to-an-r-package.html">
<a href="adding-extras-to-an-r-package.html"><i class="fa fa-check"></i><b>9</b> Adding extras to an R package</a>
<ul>
<li class="chapter" data-level="9.1" data-path="adding-extras-to-an-r-package.html"><a href="adding-extras-to-an-r-package.html#adding-a-readme"><i class="fa fa-check"></i><b>9.1</b> Adding a README</a></li>
<li class="chapter" data-level="9.2" data-path="adding-extras-to-an-r-package.html"><a href="adding-extras-to-an-r-package.html#adding-a-hex-sticker"><i class="fa fa-check"></i><b>9.2</b> Adding a hex sticker</a></li>
<li class="chapter" data-level="9.3" data-path="adding-extras-to-an-r-package.html"><a href="adding-extras-to-an-r-package.html#adding-vignettes"><i class="fa fa-check"></i><b>9.3</b> Adding vignettes</a></li>
<li class="chapter" data-level="9.4" data-path="adding-extras-to-an-r-package.html"><a href="adding-extras-to-an-r-package.html#add-a-pkgdown-site"><i class="fa fa-check"></i><b>9.4</b> Add a pkgdown site</a></li>
</ul>
</li>
<li class="chapter" data-level="10" data-path="combining-.r-files.html"><a href="combining-.r-files.html"><i class="fa fa-check"></i><b>10</b> Combining .R files</a></li>
<li class="chapter" data-level="11" data-path="including-templates.html"><a href="including-templates.html"><i class="fa fa-check"></i><b>11</b> Including templates</a></li>
<li class="chapter" data-level="12" data-path="tests.html">
<a href="tests.html"><i class="fa fa-check"></i><b>12</b> Defining some tests</a>
<ul>
<li class="chapter" data-level="12.1" data-path="tests.html"><a href="tests.html#test-check-unedited"><i class="fa fa-check"></i><b>12.1</b> Testing <code><a href="hash.html#check_unedited">check_unedited</a>()</code></a></li>
<li class="chapter" data-level="12.2" data-path="tests.html"><a href="tests.html#testing-get_params_used"><i class="fa fa-check"></i><b>12.2</b> Testing <code><a href="rendering.html#get_params_used">get_params_used</a>()</code></a></li>
<li class="chapter" data-level="12.3" data-path="tests.html"><a href="tests.html#testing-chunk-referencing"><i class="fa fa-check"></i><b>12.3</b> Testing chunk referencing</a></li>
<li class="chapter" data-level="12.4" data-path="tests.html"><a href="tests.html#testing-different-ways-of-rendering"><i class="fa fa-check"></i><b>12.4</b> Testing different ways of rendering</a></li>
<li class="chapter" data-level="12.5" data-path="tests.html"><a href="tests.html#testing-other-templates"><i class="fa fa-check"></i><b>12.5</b> Testing other templates</a></li>
</ul>
</li>
<li class="chapter" data-level="13" data-path="documenting-the-package-and-testing.html">
<a href="documenting-the-package-and-testing.html"><i class="fa fa-check"></i><b>13</b> Documenting the package and testing</a>
<ul>
<li class="chapter" data-level="13.1" data-path="documenting-the-package-and-testing.html"><a href="documenting-the-package-and-testing.html#add-examples-folder-with-the-output-of-knitting-each-example"><i class="fa fa-check"></i><b>13.1</b> Add examples folder with the output of knitting each example</a></li>
</ul>
</li>
<li class="chapter" data-level="14" data-path="including-extras-for-litr.html">
<a href="including-extras-for-litr.html"><i class="fa fa-check"></i><b>14</b> Including extras for <code>litr</code></a>
<ul>
<li class="chapter" data-level="14.1" data-path="including-extras-for-litr.html"><a href="including-extras-for-litr.html#readme-with-hex-sticker"><i class="fa fa-check"></i><b>14.1</b> README with hex sticker</a></li>
<li class="chapter" data-level="14.2" data-path="including-extras-for-litr.html"><a href="including-extras-for-litr.html#vignettes"><i class="fa fa-check"></i><b>14.2</b> Vignettes</a></li>
<li class="chapter" data-level="14.3" data-path="including-extras-for-litr.html"><a href="including-extras-for-litr.html#a-pkgdown-site"><i class="fa fa-check"></i><b>14.3</b> A pkgdown site</a></li>
</ul>
</li>
</ul></nav>
</div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Creating the <code>litr</code> R package</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-"><div id="rendering" class="section level1 hasAnchor" number="7">
<h1>
<span class="header-section-number">7</span> Altering the rendering process<a href="rendering.html#rendering" class="anchor-section" aria-label="Anchor link to header"></a>
</h1>
<p>The focus here is to make it so that all the special <code>litr</code> functionality will be active when the .Rmd is rendered. In particular, we need to make sure that <code><a href="generating-package.html#setup">setup</a>()</code> has been called before knitting occurs (so that, for example, <code><a href="generating-package.html#send_to_package">send_to_package</a>()</code> will be active). We also need to make sure that after knitting certain things occur, such as the litr-hash being written to the package and, in some cases, hyperlinks are added for easier navigation.</p>
<p>We implement two ways for the above to occur, which we describe in the next two subsections:</p>
<ol style="list-style-type: decimal">
<li><p>The first approach is by defining <a href="hash.html#output-format">custom litr output formats</a>. When <code>rmarkdown::render()</code> (or <code>bookdown::render_book()</code>) is called with one of these <code>litr</code> output formats, the <code>litr</code>-specific operations occur before and after knitting.</p></li>
<li><p>The second way is through the function <code>litr::<a href="rendering.html#render">render</a>()</code>. If a user calls <code>litr::<a href="rendering.html#render">render</a>()</code> with a non-<code>litr</code> output format, e.g. <code>rmarkdown::html_document()</code>, then it adds the necessary <code>litr</code>-specific operations before/after <code>rmarkdown::render()</code> is called. Another thing of note about <code>litr::<a href="rendering.html#render">render</a>()</code> is that it renders the document in a fresh environment, which ensures identical behavior to when a user presses “Knit” in RStudio.</p></li>
</ol>
<p>Although these are presented as two separate approaches, we have written <code>litr::<a href="rendering.html#render">render</a>()</code> so that if a user passes one of the <code>litr</code> output formats to <code>litr::<a href="rendering.html#render">render</a>()</code>, it will still work.</p>
<p>We encourage users to use <code>litr::<a href="rendering.html#render">render</a>()</code><a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> rather than <code>rmarkdown::render()</code> since in <code>litr::<a href="rendering.html#render">render</a>()</code> we’re able to wrap the call to <code>rmarkdown::render()</code> in the function <code>with_cleanup()</code>. This ensures that, if an error occurs during the knitting process, the special <code>litr</code> hash will still be created. This is desirable since it means that the next time we try to litr-knit, we will not get an error about overwriting a manually edited package directory.</p>
<p>When coding an R package with <code>litr</code>, sometimes there are code chunks that can take a while to evaluate (e.g., tests), which slows down the coding process. We therefore provide an argument (to both <code>litr::<a href="rendering.html#render">render</a>()</code> and the various litr output formats) that allows for “minimal eval” to occur. The goal is to allow the R package to be updated completely but without any of the code chunks being evaluated, except those whose involving usethis or a call to <code>litr::<a href="document.html#document">document</a>()</code>, since these commands lead to changes in the R package itself. Here is the documentation associated with the <code>minimal_eval</code> parameter, which is an argument to a number of functions in this section:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="rendering.html#cb35-1" tabindex="-1"></a><span class="co">#' @param minimal_eval If `TRUE`, then only chunks with `litr::<a href="document.html#document">document</a>()` or </span></span>
<span id="cb35-2"><a href="rendering.html#cb35-2" tabindex="-1"></a><span class="co">#' `usethis` commands will be evaluated.  This can be convenient in coding when </span></span>
<span id="cb35-3"><a href="rendering.html#cb35-3" tabindex="-1"></a><span class="co">#' you just want to quickly update the R package without having to wait for long</span></span>
<span id="cb35-4"><a href="rendering.html#cb35-4" tabindex="-1"></a><span class="co">#' evaluations to occur.</span></span></code></pre></div>
<div id="output-format" class="section level2 hasAnchor" number="7.1">
<h2>
<span class="header-section-number">7.1</span> Defining <code>litr</code> output formats<a href="hash.html#output-format" class="anchor-section" aria-label="Anchor link to header"></a>
</h2>
<p>The function <code>rmarkdown::render()</code> allows for customizable behavior through the use of custom <a href="https://bookdown.org/yihui/rmarkdown/new-formats.html">output formats</a>.</p>
<p>Given a preexisting output format (e.g. <code>rmarkdown::html_document</code>), we would like to modify it to have <code>litr</code>-behavior – i.e., to create a package as it is being rendered. This next function takes a preexisting output format and “<code>litr</code>-ifies” it by making three changes:</p>
<ol style="list-style-type: decimal">
<li><p>It modifies the <code><a href="rendering.html#pre_knit">pre_knit</a>()</code> function.</p></li>
<li><p>It modifies the <code><a href="rendering.html#post_processor">post_processor</a>()</code> function.</p></li>
<li><p>It adds a marker (<code>litr_format &lt;- TRUE</code>) that will help <code>litr::<a href="rendering.html#render">render</a>()</code> know when a <code>litr</code> output format is being passed to it.</p></li>
</ol>
<p>We present the function and then describe the details of the new <code><a href="rendering.html#pre_knit">pre_knit</a>()</code> and <code><a href="rendering.html#post_processor">post_processor</a>()</code> functions below.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="rendering.html#cb36-1" tabindex="-1"></a><span class="co">#' Modify an existing output format to have `litr` behavior</span></span>
<span id="cb36-2"><a href="rendering.html#cb36-2" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb36-3"><a href="rendering.html#cb36-3" tabindex="-1"></a><span class="co">#' This function modifies the `<a href="rendering.html#pre_knit">pre_knit</a>()` and `<a href="rendering.html#post_processor">post_processor</a>()` functions of a</span></span>
<span id="cb36-4"><a href="rendering.html#cb36-4" tabindex="-1"></a><span class="co">#' preexisting output format so that it will have the `litr` behavior (meaning that an R package will be created when `rmarkdown::render()` is called).</span></span>
<span id="cb36-5"><a href="rendering.html#cb36-5" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb36-6"><a href="rendering.html#cb36-6" tabindex="-1"></a><span class="co">#' @param base_format a preexisting, non-litr output format such as `rmarkdown::html_document`</span></span>
<span id="cb36-7"><a href="rendering.html#cb36-7" tabindex="-1"></a><span class="co">#' @param minimal_eval If `TRUE`, then only chunks with `litr::<a href="document.html#document">document</a>()` or </span></span>
<span id="cb36-8"><a href="rendering.html#cb36-8" tabindex="-1"></a><span class="co">#' `usethis` commands will be evaluated.  This can be convenient in coding when </span></span>
<span id="cb36-9"><a href="rendering.html#cb36-9" tabindex="-1"></a><span class="co">#' you just want to quickly update the R package without having to wait for long</span></span>
<span id="cb36-10"><a href="rendering.html#cb36-10" tabindex="-1"></a><span class="co">#' evaluations to occur.</span></span>
<span id="cb36-11"><a href="rendering.html#cb36-11" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb36-12"><a href="rendering.html#cb36-12" tabindex="-1"></a><span id="litrify_output_format">litrify_output_format</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">base_format =</span> rmarkdown<span class="sc">::</span>html_document,</span>
<span id="cb36-13"><a href="rendering.html#cb36-13" tabindex="-1"></a>                                  <span class="at">minimal_eval =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb36-14"><a href="rendering.html#cb36-14" tabindex="-1"></a>  <span class="fu">force</span>(base_format) <span class="co"># I think using force here is advisable?</span></span>
<span id="cb36-15"><a href="rendering.html#cb36-15" tabindex="-1"></a>  <span class="fu">force</span>(minimal_eval) <span class="co"># https://adv-r.hadley.nz/function-factories.html</span></span>
<span id="cb36-16"><a href="rendering.html#cb36-16" tabindex="-1"></a>  <span class="cf">function</span>(...) {</span>
<span id="cb36-17"><a href="rendering.html#cb36-17" tabindex="-1"></a>    old <span class="ot">&lt;-</span> <span class="fu">base_format</span>(...)</span>
<span id="cb36-18"><a href="rendering.html#cb36-18" tabindex="-1"></a>    new <span class="ot">&lt;-</span> old</span>
<span id="cb36-19"><a href="rendering.html#cb36-19" tabindex="-1"></a>    new<span class="sc">$</span>original_knitr_objects <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb36-20"><a href="rendering.html#cb36-20" tabindex="-1"></a>    new<span class="sc">$</span><span id="pre_knit">pre_knit</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(...) {</span>
<span id="cb36-21"><a href="rendering.html#cb36-21" tabindex="-1"></a>      args <span class="ot">&lt;-</span> <span class="fu">list</span>(...)</span>
<span id="cb36-22"><a href="rendering.html#cb36-22" tabindex="-1"></a>      input <span class="ot">&lt;-</span> args<span class="sc">$</span>input</span>
<span id="cb36-23"><a href="rendering.html#cb36-23" tabindex="-1"></a>      params <span class="ot">&lt;-</span> knitr<span class="sc">::</span><span class="fu">knit_params</span>(<span class="fu">readLines</span>(input))</span>
<span id="cb36-24"><a href="rendering.html#cb36-24" tabindex="-1"></a>      package_dir <span class="ot">&lt;-</span> <a href="rendering.html#get_package_directory">get_package_directory</a>(</span>
<span id="cb36-25"><a href="rendering.html#cb36-25" tabindex="-1"></a>        params<span class="sc">$</span>package_parent_dir<span class="sc">$</span>value,</span>
<span id="cb36-26"><a href="rendering.html#cb36-26" tabindex="-1"></a>        params<span class="sc">$</span>package_name<span class="sc">$</span>value,</span>
<span id="cb36-27"><a href="rendering.html#cb36-27" tabindex="-1"></a>        input)</span>
<span id="cb36-28"><a href="rendering.html#cb36-28" tabindex="-1"></a>      new<span class="sc">$</span>original_knitr_objects <span class="ot">&lt;&lt;-</span> litr<span class="sc">:::</span><a href="generating-package.html#setup">setup</a>(package_dir, minimal_eval)</span>
<span id="cb36-29"><a href="rendering.html#cb36-29" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(old<span class="sc">$</span>pre_knit)) old<span class="sc">$</span><a href="rendering.html#pre_knit">pre_knit</a>(...)</span>
<span id="cb36-30"><a href="rendering.html#cb36-30" tabindex="-1"></a>    }</span>
<span id="cb36-31"><a href="rendering.html#cb36-31" tabindex="-1"></a></span>
<span id="cb36-32"><a href="rendering.html#cb36-32" tabindex="-1"></a>    new<span class="sc">$</span><span id="post_processor">post_processor</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(metadata, input_file, output_file, ...) {</span>
<span id="cb36-33"><a href="rendering.html#cb36-33" tabindex="-1"></a>      <span class="co"># typically the post_processor function returns the output file path</span></span>
<span id="cb36-34"><a href="rendering.html#cb36-34" tabindex="-1"></a>      <span class="co"># if old$post_processor is NULL, as in the case of pdf_document,</span></span>
<span id="cb36-35"><a href="rendering.html#cb36-35" tabindex="-1"></a>      <span class="co"># then R will throw an error when trying to call old$post_processor</span></span>
<span id="cb36-36"><a href="rendering.html#cb36-36" tabindex="-1"></a>      <span class="co"># if we only add a check for non null old$post_processor and otherwise</span></span>
<span id="cb36-37"><a href="rendering.html#cb36-37" tabindex="-1"></a>      <span class="co"># set out &lt;- NULL then R will throw an error later in rmarkdown::render</span></span>
<span id="cb36-38"><a href="rendering.html#cb36-38" tabindex="-1"></a>      <span class="co"># since output_file is set to the output of the post_processor if </span></span>
<span id="cb36-39"><a href="rendering.html#cb36-39" tabindex="-1"></a>      <span class="co"># output_format$post_processor is not null (See line 478 in rmarkdown::render)</span></span>
<span id="cb36-40"><a href="rendering.html#cb36-40" tabindex="-1"></a>      <span class="co"># Therefore, our solution is to set out to the output_file path if old$post_process is null.</span></span>
<span id="cb36-41"><a href="rendering.html#cb36-41" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(old<span class="sc">$</span>post_processor)){</span>
<span id="cb36-42"><a href="rendering.html#cb36-42" tabindex="-1"></a>        out <span class="ot">&lt;-</span> old<span class="sc">$</span><a href="rendering.html#post_processor">post_processor</a>(metadata, input_file, output_file, ...)  </span>
<span id="cb36-43"><a href="rendering.html#cb36-43" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb36-44"><a href="rendering.html#cb36-44" tabindex="-1"></a>        out <span class="ot">&lt;-</span> output_file </span>
<span id="cb36-45"><a href="rendering.html#cb36-45" tabindex="-1"></a>      }</span>
<span id="cb36-46"><a href="rendering.html#cb36-46" tabindex="-1"></a>      package_dir <span class="ot">&lt;-</span> <a href="rendering.html#get_package_directory">get_package_directory</a>(</span>
<span id="cb36-47"><a href="rendering.html#cb36-47" tabindex="-1"></a>        metadata<span class="sc">$</span>params<span class="sc">$</span>package_parent_dir,</span>
<span id="cb36-48"><a href="rendering.html#cb36-48" tabindex="-1"></a>        metadata<span class="sc">$</span>params<span class="sc">$</span>package_name,</span>
<span id="cb36-49"><a href="rendering.html#cb36-49" tabindex="-1"></a>        input_file</span>
<span id="cb36-50"><a href="rendering.html#cb36-50" tabindex="-1"></a>      )</span>
<span id="cb36-51"><a href="rendering.html#cb36-51" tabindex="-1"></a>      <span class="co"># remove .Rproj and .gitignore if usethis::create_package() added these</span></span>
<span id="cb36-52"><a href="rendering.html#cb36-52" tabindex="-1"></a>      <a href="rendering.html#remove_rstudio_extras">remove_rstudio_extras</a>(package_dir)</span>
<span id="cb36-53"><a href="rendering.html#cb36-53" tabindex="-1"></a></span>
<span id="cb36-54"><a href="rendering.html#cb36-54" tabindex="-1"></a>      <span class="co"># add to DESCRIPTION file the version of litr used to create package:</span></span>
<span id="cb36-55"><a href="rendering.html#cb36-55" tabindex="-1"></a>      <a href="rendering.html#write_version_to_description">write_version_to_description</a>(package_dir)</span>
<span id="cb36-56"><a href="rendering.html#cb36-56" tabindex="-1"></a></span>
<span id="cb36-57"><a href="rendering.html#cb36-57" tabindex="-1"></a>      <span class="co"># add litr hash so we can tell later if package files were manually edited:</span></span>
<span id="cb36-58"><a href="rendering.html#cb36-58" tabindex="-1"></a>      <a href="hash.html#write_hash_to_description">write_hash_to_description</a>(package_dir)</span>
<span id="cb36-59"><a href="rendering.html#cb36-59" tabindex="-1"></a>      </span>
<span id="cb36-60"><a href="rendering.html#cb36-60" tabindex="-1"></a>      out</span>
<span id="cb36-61"><a href="rendering.html#cb36-61" tabindex="-1"></a>    }</span>
<span id="cb36-62"><a href="rendering.html#cb36-62" tabindex="-1"></a>    </span>
<span id="cb36-63"><a href="rendering.html#cb36-63" tabindex="-1"></a>    new<span class="sc">$</span><span id="on_exit">on_exit</span> <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb36-64"><a href="rendering.html#cb36-64" tabindex="-1"></a>      old<span class="sc">$</span><a href="rendering.html#on_exit">on_exit</a>()</span>
<span id="cb36-65"><a href="rendering.html#cb36-65" tabindex="-1"></a>      </span>
<span id="cb36-66"><a href="rendering.html#cb36-66" tabindex="-1"></a>      <span class="co"># restore knitr to its original state</span></span>
<span id="cb36-67"><a href="rendering.html#cb36-67" tabindex="-1"></a>      <a href="rendering.html#restore_knitr_objects">restore_knitr_objects</a>(new<span class="sc">$</span>original_knitr_objects)</span>
<span id="cb36-68"><a href="rendering.html#cb36-68" tabindex="-1"></a>    }</span>
<span id="cb36-69"><a href="rendering.html#cb36-69" tabindex="-1"></a>    </span>
<span id="cb36-70"><a href="rendering.html#cb36-70" tabindex="-1"></a>    <span class="co"># mark this as a litr_format</span></span>
<span id="cb36-71"><a href="rendering.html#cb36-71" tabindex="-1"></a>    new<span class="sc">$</span>litr_format <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb36-72"><a href="rendering.html#cb36-72" tabindex="-1"></a>    </span>
<span id="cb36-73"><a href="rendering.html#cb36-73" tabindex="-1"></a>    <span class="co"># litr formats have minimal_eval as an option</span></span>
<span id="cb36-74"><a href="rendering.html#cb36-74" tabindex="-1"></a>    new<span class="sc">$</span>minimal_eval <span class="ot">&lt;-</span> minimal_eval</span>
<span id="cb36-75"><a href="rendering.html#cb36-75" tabindex="-1"></a></span>
<span id="cb36-76"><a href="rendering.html#cb36-76" tabindex="-1"></a>    new</span>
<span id="cb36-77"><a href="rendering.html#cb36-77" tabindex="-1"></a>  }</span>
<span id="cb36-78"><a href="rendering.html#cb36-78" tabindex="-1"></a>}</span></code></pre></div>
<ol style="list-style-type: decimal">
<li><p>The <code>pre_knit()</code> function is modified so that <code>setup()</code> is called before the preexisting output format’s <code>pre_knit()</code> function is called. As the name suggests, this is a function that gets called before knitting. The purpose of the call to <code>setup()</code> is to create the R package directory and make it so that when we knit the file using <code>rmarkdown::render()</code>, a lot of special things will happen, such as code being sent to the R package directory. The function <code>setup()</code> returns the state of the <code>knitr</code> settings before any changes were made. This previous state of the knitr settings will be restored at the end of the rendering process in <code>on_exit()</code>.</p></li>
<li><p>The <code><a href="rendering.html#post_processor">post_processor</a>()</code> function is modified so that the DESCRIPTION file gets marked with the version of <code>litr</code> used and with the <code>litr</code> hash (as already described <a href="hash.html#hash">here</a>). Some special care is taken for the case that the original output format doesn’t have a post processor (e.g., this is the case for the <code>pdf_document</code> output format). The particulars of this are given in a comment in the code chunk above.</p></li>
<li><p>The <code><a href="rendering.html#on_exit">on_exit</a>()</code> function is modified so that it restores the state of all the knitr settings to how it was when render was first called.</p></li>
</ol>
<p>We use the above function to create some <code>litr</code> versions of common output formats, as seen in the next few subsections.</p>
<p>Before proceeding, we define the function <code><a href="rendering.html#write_version_to_description">write_version_to_description</a>()</code> that is called above.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="rendering.html#cb37-1" tabindex="-1"></a><span class="co">#' Generate litr version field name for DESCRIPTION file</span></span>
<span id="cb37-2"><a href="rendering.html#cb37-2" tabindex="-1"></a><span class="co">#' @keywords internal</span></span>
<span id="cb37-3"><a href="rendering.html#cb37-3" tabindex="-1"></a><span id="description_litr_version_field_name">description_litr_version_field_name</span> <span class="ot">&lt;-</span> <span class="cf">function</span>() <span class="fu">return</span>(<span class="st">"LitrVersionUsed"</span>)</span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="rendering.html#cb38-1" tabindex="-1"></a><span class="co">#' Write the version of litr used to the DESCRIPTION file</span></span>
<span id="cb38-2"><a href="rendering.html#cb38-2" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb38-3"><a href="rendering.html#cb38-3" tabindex="-1"></a><span class="co">#' @param package_dir Path to package</span></span>
<span id="cb38-4"><a href="rendering.html#cb38-4" tabindex="-1"></a><span class="co">#' @keywords internal</span></span>
<span id="cb38-5"><a href="rendering.html#cb38-5" tabindex="-1"></a><span id="write_version_to_description">write_version_to_description</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(package_dir) {</span>
<span id="cb38-6"><a href="rendering.html#cb38-6" tabindex="-1"></a>  ver <span class="ot">&lt;-</span> <span class="fu">as.character</span>(utils<span class="sc">::</span><span class="fu">packageVersion</span>(<span class="st">"litr"</span>))</span>
<span id="cb38-7"><a href="rendering.html#cb38-7" tabindex="-1"></a>  <a href="generating-package.html#add_text_to_file">add_text_to_file</a>(</span>
<span id="cb38-8"><a href="rendering.html#cb38-8" tabindex="-1"></a>    <span class="at">txt =</span> stringr<span class="sc">::</span><span class="fu">str_glue</span>(<span class="st">"{<a href="rendering.html#description_litr_version_field_name">description_litr_version_field_name</a>()}: {ver}"</span>),</span>
<span id="cb38-9"><a href="rendering.html#cb38-9" tabindex="-1"></a>    <span class="at">filename =</span> <span class="fu">file.path</span>(package_dir, <span class="st">"DESCRIPTION"</span>),</span>
<span id="cb38-10"><a href="rendering.html#cb38-10" tabindex="-1"></a>    <span class="at">req_exist =</span> <span class="cn">TRUE</span></span>
<span id="cb38-11"><a href="rendering.html#cb38-11" tabindex="-1"></a>    )</span>
<span id="cb38-12"><a href="rendering.html#cb38-12" tabindex="-1"></a>}</span></code></pre></div>
<p>Also, we made use of a small function for getting the package directory based on the input file’s location and the parameters that are being used in the rendering process. We define it here:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="rendering.html#cb39-1" tabindex="-1"></a><span class="co">#' Get package directory</span></span>
<span id="cb39-2"><a href="rendering.html#cb39-2" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb39-3"><a href="rendering.html#cb39-3" tabindex="-1"></a><span class="co">#' @param package_parent_dir The directory of where the package should go (relative to the input directory)</span></span>
<span id="cb39-4"><a href="rendering.html#cb39-4" tabindex="-1"></a><span class="co">#' @param package_name The name of the package</span></span>
<span id="cb39-5"><a href="rendering.html#cb39-5" tabindex="-1"></a><span class="co">#' @param input The file name of the input</span></span>
<span id="cb39-6"><a href="rendering.html#cb39-6" tabindex="-1"></a><span class="co">#' @keywords internal</span></span>
<span id="cb39-7"><a href="rendering.html#cb39-7" tabindex="-1"></a><span id="get_package_directory">get_package_directory</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(package_parent_dir, package_name, input) {</span>
<span id="cb39-8"><a href="rendering.html#cb39-8" tabindex="-1"></a>  <span class="cf">if</span> (package_parent_dir <span class="sc">==</span> <span class="st">"."</span>)</span>
<span id="cb39-9"><a href="rendering.html#cb39-9" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">file.path</span>(<span class="fu">dirname</span>(input), package_name))</span>
<span id="cb39-10"><a href="rendering.html#cb39-10" tabindex="-1"></a>  <span class="fu">file.path</span>(<span class="fu">dirname</span>(input), package_parent_dir, package_name)</span>
<span id="cb39-11"><a href="rendering.html#cb39-11" tabindex="-1"></a>}</span></code></pre></div>
<p>Let’s write some tests to make sure it’s behaving as expected:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="rendering.html#cb40-1" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_that</span>(<span class="st">"<a href="rendering.html#get_package_directory">get_package_directory</a>() works"</span>, {</span>
<span id="cb40-2"><a href="rendering.html#cb40-2" tabindex="-1"></a>  input <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"inputdir"</span>, <span class="st">"input.Rmd"</span>)</span>
<span id="cb40-3"><a href="rendering.html#cb40-3" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(</span>
<span id="cb40-4"><a href="rendering.html#cb40-4" tabindex="-1"></a>    <a href="rendering.html#get_package_directory">get_package_directory</a>(<span class="st">"."</span>, <span class="st">"mypkg"</span>, input),</span>
<span id="cb40-5"><a href="rendering.html#cb40-5" tabindex="-1"></a>    <span class="fu">file.path</span>(<span class="st">"inputdir"</span>, <span class="st">"mypkg"</span>) <span class="co"># inputdir/mypkg</span></span>
<span id="cb40-6"><a href="rendering.html#cb40-6" tabindex="-1"></a>  )</span>
<span id="cb40-7"><a href="rendering.html#cb40-7" tabindex="-1"></a>  testthat<span class="sc">::</span><span class="fu">expect_equal</span>(</span>
<span id="cb40-8"><a href="rendering.html#cb40-8" tabindex="-1"></a>    <a href="rendering.html#get_package_directory">get_package_directory</a>(<span class="st">".."</span>, <span class="st">"mypkg"</span>, input),</span>
<span id="cb40-9"><a href="rendering.html#cb40-9" tabindex="-1"></a>    <span class="fu">file.path</span>(<span class="st">"inputdir"</span>, <span class="st">".."</span>, <span class="st">"mypkg"</span>) <span class="co"># inputdir/../mypkg</span></span>
<span id="cb40-10"><a href="rendering.html#cb40-10" tabindex="-1"></a>  )</span>
<span id="cb40-11"><a href="rendering.html#cb40-11" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Test passed</code></pre>
<div id="pdf-output-format" class="section level3 hasAnchor" number="7.1.1">
<h3>
<span class="header-section-number">7.1.1</span> .pdf output format<a href="rendering.html#pdf-output-format" class="anchor-section" aria-label="Anchor link to header"></a>
</h3>
<p>We want our .pdf documents to accurately display the “logging” output from functions in packages such as <code>devtools</code> that use special <a href="https://en.wikipedia.org/wiki/ANSI_escape_code">ANSI escape codes</a> for displaying information in the terminal. Unfortunately, these codes use escape characters which cause problems when creating .pdf versions of our documents. While it is relatively straightforward to map ANSI escape codes to HTML tags, as we will see in the <a href="rendering.html#html-output-format">.html output format section</a>, converting these escape codes to Latex commands is more complicated. As a result, we define a <code>post_knit</code> function in our <code>litr_pdf_document</code> format to avoid this issue by stripping out all escape codes in the file before it is converted into a .tex file and then compiled into a .pdf document.</p>
<p>Specifically, the <code>post_knit</code> function modifies the intermediate .knit.md file, which contains both the .Rmd file, as well as the output of each code chunk. Thus, we can inspect the output text of each code chunk and remove any ANSI escape codes before the .knit.md is converted to a .tex file and then a .pdf document. We rely upon two internal functions from the <code>fansi</code> R package to remove all possible escape codes and return a clean character vector.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="rendering.html#cb42-1" tabindex="-1"></a><span class="co">#' litr version of `rmarkdown::pdf_<a href="document.html#document">document</a>()`</span></span>
<span id="cb42-2"><a href="rendering.html#cb42-2" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb42-3"><a href="rendering.html#cb42-3" tabindex="-1"></a><span class="co">#' This behaves exactly like `rmarkdown::pdf_<a href="document.html#document">document</a>()` except it creates an </span></span>
<span id="cb42-4"><a href="rendering.html#cb42-4" tabindex="-1"></a><span class="co">#' R package.</span></span>
<span id="cb42-5"><a href="rendering.html#cb42-5" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb42-6"><a href="rendering.html#cb42-6" tabindex="-1"></a><span class="co">#' @param minimal_eval If `TRUE`, then only chunks with `litr::<a href="document.html#document">document</a>()` or </span></span>
<span id="cb42-7"><a href="rendering.html#cb42-7" tabindex="-1"></a><span class="co">#' `usethis` commands will be evaluated.  This can be convenient in coding when </span></span>
<span id="cb42-8"><a href="rendering.html#cb42-8" tabindex="-1"></a><span class="co">#' you just want to quickly update the R package without having to wait for long</span></span>
<span id="cb42-9"><a href="rendering.html#cb42-9" tabindex="-1"></a><span class="co">#' evaluations to occur.</span></span>
<span id="cb42-10"><a href="rendering.html#cb42-10" tabindex="-1"></a><span class="co">#' @param ... Parameters to be passed to `rmarkdown::pdf_<a href="document.html#document">document</a>()` </span></span>
<span id="cb42-11"><a href="rendering.html#cb42-11" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb42-12"><a href="rendering.html#cb42-12" tabindex="-1"></a><span id="litr_pdf_document">litr_pdf_document</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">minimal_eval =</span> <span class="cn">FALSE</span>, ...) {</span>
<span id="cb42-13"><a href="rendering.html#cb42-13" tabindex="-1"></a>  litr_pdf_document_ <span class="ot">&lt;-</span> <a href="rendering.html#litrify_output_format">litrify_output_format</a>(rmarkdown<span class="sc">::</span>pdf_document,</span>
<span id="cb42-14"><a href="rendering.html#cb42-14" tabindex="-1"></a>                                              <span class="at">minimal_eval =</span> minimal_eval)</span>
<span id="cb42-15"><a href="rendering.html#cb42-15" tabindex="-1"></a>  old <span class="ot">&lt;-</span> <span class="fu">litr_pdf_document_</span>(...)</span>
<span id="cb42-16"><a href="rendering.html#cb42-16" tabindex="-1"></a>  new <span class="ot">&lt;-</span> old</span>
<span id="cb42-17"><a href="rendering.html#cb42-17" tabindex="-1"></a></span>
<span id="cb42-18"><a href="rendering.html#cb42-18" tabindex="-1"></a>  <span class="co"># post_knit</span></span>
<span id="cb42-19"><a href="rendering.html#cb42-19" tabindex="-1"></a>  new<span class="sc">$</span>post_knit <span class="ot">=</span> <span class="cf">function</span>(...){</span>
<span id="cb42-20"><a href="rendering.html#cb42-20" tabindex="-1"></a>    args <span class="ot">=</span> <span class="fu">list</span>(...)</span>
<span id="cb42-21"><a href="rendering.html#cb42-21" tabindex="-1"></a>    input_filename <span class="ot">&lt;-</span> args[[<span class="dv">2</span>]]</span>
<span id="cb42-22"><a href="rendering.html#cb42-22" tabindex="-1"></a>    knitted_filename <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path_ext_set</span>(input_filename, <span class="st">".knit.md"</span>)</span>
<span id="cb42-23"><a href="rendering.html#cb42-23" tabindex="-1"></a>    knitted_output <span class="ot">&lt;-</span> <span class="fu">readLines</span>(knitted_filename)</span>
<span id="cb42-24"><a href="rendering.html#cb42-24" tabindex="-1"></a>    cleaned_output <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(knitted_output), <span class="cf">function</span>(i){</span>
<span id="cb42-25"><a href="rendering.html#cb42-25" tabindex="-1"></a>      test_str <span class="ot">&lt;-</span> knitted_output[i]</span>
<span id="cb42-26"><a href="rendering.html#cb42-26" tabindex="-1"></a>      fansi<span class="sc">:::</span><span class="fu">VAL_IN_ENV</span>(<span class="at">x=</span>test_str, <span class="at">ctl=</span><span class="st">"all"</span>, <span class="at">warn=</span><span class="cn">TRUE</span>, <span class="at">warn.mask=</span>fansi<span class="sc">:::</span><span class="fu">get_warn_mangled</span>())</span>
<span id="cb42-27"><a href="rendering.html#cb42-27" tabindex="-1"></a>      <span class="fu">.Call</span>(fansi<span class="sc">:::</span>FANSI_strip_csi, test_str, CTL.INT, WARN.INT)</span>
<span id="cb42-28"><a href="rendering.html#cb42-28" tabindex="-1"></a>    })</span>
<span id="cb42-29"><a href="rendering.html#cb42-29" tabindex="-1"></a>    <span class="fu">writeLines</span>(cleaned_output, knitted_filename)</span>
<span id="cb42-30"><a href="rendering.html#cb42-30" tabindex="-1"></a>  }</span>
<span id="cb42-31"><a href="rendering.html#cb42-31" tabindex="-1"></a>  new</span>
<span id="cb42-32"><a href="rendering.html#cb42-32" tabindex="-1"></a>}</span></code></pre></div>
<p>Since the above section uses the <code>fansi</code> package for handling ANSI escape sequences, we include it in our package:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="rendering.html#cb43-1" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_package</span>(<span class="st">"fansi"</span>)</span></code></pre></div>
<pre><code>## ✔ Adding 'fansi' to Imports field in DESCRIPTION
## • Refer to functions with `fansi::fun()`</code></pre>
</div>
<div id="html-output-format" class="section level3 hasAnchor" number="7.1.2">
<h3>
<span class="header-section-number">7.1.2</span> .html output format<a href="rendering.html#html-output-format" class="anchor-section" aria-label="Anchor link to header"></a>
</h3>
<p>For .html documents, we’d like to add a bit more in the postprocessing step. In particular, we include some special function and chunk hyperlinking behavior described below. The function <code><a href="rendering.html#add_function_hyperlinks">add_function_hyperlinks</a>()</code> processes the outputted .html file(s), making it so that one can easily navigate to function definitions. (This function is described lower in this section.) We likewise call a function <code><a href="rendering.html#add_chunk_label_hyperlinks">add_chunk_label_hyperlinks</a>()</code>, which makes chunk references into clickable links. In particular, the chunk reference <code>&lt;&lt;my-chunk&gt;&gt;</code> within a code chunk would link to a chunk named “my-chunk” that begins with <code>###"my-chunk"###</code>. The <code>###"my-chunk"###</code> line is added by a document hook defined in <code><a href="generating-package.html#setup">setup</a>()</code>. Finally, we replace ANSI sequences with HTML tag equivalents (the need for this is explained in the <a href="rendering.html#pdf-output-format">section on the .pdf output format</a>).</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="rendering.html#cb45-1" tabindex="-1"></a><span class="co">#' litr version of `rmarkdown::html_<a href="document.html#document">document</a>()`</span></span>
<span id="cb45-2"><a href="rendering.html#cb45-2" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb45-3"><a href="rendering.html#cb45-3" tabindex="-1"></a><span class="co">#' This behaves like `rmarkdown::html_<a href="document.html#document">document</a>()` with a few differences:</span></span>
<span id="cb45-4"><a href="rendering.html#cb45-4" tabindex="-1"></a><span class="co">#' - It creates an R package.</span></span>
<span id="cb45-5"><a href="rendering.html#cb45-5" tabindex="-1"></a><span class="co">#' - It adds hyperlinks to function definitions whenever a function is used</span></span>
<span id="cb45-6"><a href="rendering.html#cb45-6" tabindex="-1"></a><span class="co">#' elsewhere in the document.</span></span>
<span id="cb45-7"><a href="rendering.html#cb45-7" tabindex="-1"></a><span class="co">#' - It does "Knuth-style" chunk referencing with hyperlinks.</span></span>
<span id="cb45-8"><a href="rendering.html#cb45-8" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb45-9"><a href="rendering.html#cb45-9" tabindex="-1"></a><span class="co">#' @param minimal_eval If `TRUE`, then only chunks with `litr::<a href="document.html#document">document</a>()` or </span></span>
<span id="cb45-10"><a href="rendering.html#cb45-10" tabindex="-1"></a><span class="co">#' `usethis` commands will be evaluated.  This can be convenient in coding when </span></span>
<span id="cb45-11"><a href="rendering.html#cb45-11" tabindex="-1"></a><span class="co">#' you just want to quickly update the R package without having to wait for long</span></span>
<span id="cb45-12"><a href="rendering.html#cb45-12" tabindex="-1"></a><span class="co">#' evaluations to occur.</span></span>
<span id="cb45-13"><a href="rendering.html#cb45-13" tabindex="-1"></a><span class="co">#' @param ... Parameters to be passed to `rmarkdown::pdf_<a href="document.html#document">document</a>()` </span></span>
<span id="cb45-14"><a href="rendering.html#cb45-14" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb45-15"><a href="rendering.html#cb45-15" tabindex="-1"></a><span id="litr_html_document">litr_html_document</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">minimal_eval =</span> <span class="cn">FALSE</span>, ...) {</span>
<span id="cb45-16"><a href="rendering.html#cb45-16" tabindex="-1"></a>  litr_html_document_ <span class="ot">&lt;-</span> <a href="rendering.html#litrify_output_format">litrify_output_format</a>(rmarkdown<span class="sc">::</span>html_document,</span>
<span id="cb45-17"><a href="rendering.html#cb45-17" tabindex="-1"></a>                                               <span class="at">minimal_eval =</span> minimal_eval)</span>
<span id="cb45-18"><a href="rendering.html#cb45-18" tabindex="-1"></a>  old <span class="ot">&lt;-</span> <span class="fu">litr_html_document_</span>(...)</span>
<span id="cb45-19"><a href="rendering.html#cb45-19" tabindex="-1"></a>  new <span class="ot">&lt;-</span> old</span>
<span id="cb45-20"><a href="rendering.html#cb45-20" tabindex="-1"></a>  <span class="co"># modify post_processor</span></span>
<span id="cb45-21"><a href="rendering.html#cb45-21" tabindex="-1"></a>  new<span class="sc">$</span>post_processor <span class="ot">=</span> <span class="cf">function</span>(metadata, input_file, output_file, ...) {</span>
<span id="cb45-22"><a href="rendering.html#cb45-22" tabindex="-1"></a>    out <span class="ot">&lt;-</span> old<span class="sc">$</span><a href="rendering.html#post_processor">post_processor</a>(metadata, input_file, output_file, ...)</span>
<span id="cb45-23"><a href="rendering.html#cb45-23" tabindex="-1"></a>    <span class="co"># html_files &lt;- fs::dir_ls(fs::path_dir(out), regexp = ".html$")</span></span>
<span id="cb45-24"><a href="rendering.html#cb45-24" tabindex="-1"></a>    <span class="co"># add hyperlinks within html output to make it easier to navigate:</span></span>
<span id="cb45-25"><a href="rendering.html#cb45-25" tabindex="-1"></a>    <a href="rendering.html#add_function_hyperlinks">add_function_hyperlinks</a>(output_file, metadata<span class="sc">$</span>params<span class="sc">$</span>package_name)</span>
<span id="cb45-26"><a href="rendering.html#cb45-26" tabindex="-1"></a>    <a href="rendering.html#add_chunk_label_hyperlinks">add_chunk_label_hyperlinks</a>(output_file)</span>
<span id="cb45-27"><a href="rendering.html#cb45-27" tabindex="-1"></a>    <span class="co"># replace ANSI sequences with HTML tag equivalents</span></span>
<span id="cb45-28"><a href="rendering.html#cb45-28" tabindex="-1"></a>    <a href="rendering.html#replace_ansi_sequences">replace_ansi_sequences</a>(output_file)</span>
<span id="cb45-29"><a href="rendering.html#cb45-29" tabindex="-1"></a>    out</span>
<span id="cb45-30"><a href="rendering.html#cb45-30" tabindex="-1"></a>  }</span>
<span id="cb45-31"><a href="rendering.html#cb45-31" tabindex="-1"></a>  new</span>
<span id="cb45-32"><a href="rendering.html#cb45-32" tabindex="-1"></a>}</span></code></pre></div>
<p>We describe these two <code>add_*_hyperlinks()</code> functions next.</p>
<p>The function <code><a href="rendering.html#add_function_hyperlinks">add_function_hyperlinks</a>()</code> looks for <code>foo</code> followed by <code>&lt;- function(</code> and then wraps <code>foo</code> in a <code>span</code> tag with <code>id="foo"</code>; whenever <code>foo</code> is found elsewhere in the document, it calls the <code><a href="rendering.html#insert_hrefs">insert_hrefs</a>()</code> function to wrap a <code>a href="file.html#foo"</code> tag (where <code>file.html</code> is the file where <code>foo</code> is defined), so that it will be a hyperlink to <code>foo</code>’s definition.</p>
<div class="sourceCode" id="cb46"><fieldset id="foo" class="chunkfield"> <pre class="sourceCode r"><code><span id="cb46-1"><a href="rendering.html#cb46-1" tabindex="-1"></a><span class="co">#' Add hyperlinks to function definitions</span></span><span id="cb46-2"><a href="rendering.html#cb46-2" tabindex="-1"></a><span class="co">#' </span></span><span id="cb46-3"><a href="rendering.html#cb46-3" tabindex="-1"></a><span class="co">#' Finds functions that are defined in the html file(s) by looking for text of the </span></span><span id="cb46-4"><a href="rendering.html#cb46-4" tabindex="-1"></a><span class="co">#' form ` &lt;- function(` and then wraps `foo` in a `span` tag with `id="foo"` </span></span><span id="cb46-5"><a href="rendering.html#cb46-5" tabindex="-1"></a><span class="co">#' and then whenever `foo` is found it wraps a `a href="file.html#foo"` tag so </span></span><span id="cb46-6"><a href="rendering.html#cb46-6" tabindex="-1"></a><span class="co">#' that it will be a hyperlink to `foo`'s definition.</span></span><span id="cb46-7"><a href="rendering.html#cb46-7" tabindex="-1"></a><span class="co">#' </span></span><span id="cb46-8"><a href="rendering.html#cb46-8" tabindex="-1"></a><span class="co">#' @param html_files Character vector of file names of html files that were created</span></span><span id="cb46-9"><a href="rendering.html#cb46-9" tabindex="-1"></a><span class="co">#' from Rmd files</span></span><span id="cb46-10"><a href="rendering.html#cb46-10" tabindex="-1"></a><span class="co">#' @param pkg_name Name of the package created by litr. Taken from YAML front matter</span></span><span id="cb46-11"><a href="rendering.html#cb46-11" tabindex="-1"></a><span class="co">#' @keywords internal</span></span><span id="cb46-12"><a href="rendering.html#cb46-12" tabindex="-1"></a><span id="add_function_hyperlinks">add_function_hyperlinks</span><span class="ot">&lt;-</span><span class="cf">function</span>(html_files, pkg_name) {</span><span id="cb46-13"><a href="rendering.html#cb46-13" tabindex="-1"></a><span id="find_function_defs">find_function_defs</span><span class="ot">&lt;-</span><span class="cf">function</span>(html_file) {</span><span id="cb46-14"><a href="rendering.html#cb46-14" tabindex="-1"></a>    txt <span class="ot">&lt;-</span> <span class="fu">readLines</span>(html_file)</span><span id="cb46-15"><a href="rendering.html#cb46-15" tabindex="-1"></a>    start_line <span class="ot">&lt;-</span> <span class="fu">which</span>(txt <span class="sc">==</span> <span class="st">"&lt;body&gt;"</span>)</span><span id="cb46-16"><a href="rendering.html#cb46-16" tabindex="-1"></a>    pattern1 <span class="ot">&lt;-</span> <span class="st">'([a-zA-Z0-9_.]+)(</span><span class="sc">\\</span><span class="st">s*&amp;lt;-</span><span class="sc">\\</span><span class="st">s*function)'</span></span><span id="cb46-17"><a href="rendering.html#cb46-17" tabindex="-1"></a>    pattern2 <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(pattern1,</span><span id="cb46-18"><a href="rendering.html#cb46-18" tabindex="-1"></a><span class="st">'&amp;lt;-'</span>,</span><span id="cb46-19"><a href="rendering.html#cb46-19" tabindex="-1"></a><span class="st">'&lt;span class="ot"&gt;&amp;lt;-&lt;/span&gt;'</span>)</span><span id="cb46-20"><a href="rendering.html#cb46-20" tabindex="-1"></a>    pattern2 <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(pattern2,</span><span id="cb46-21"><a href="rendering.html#cb46-21" tabindex="-1"></a><span class="st">'function'</span>,</span><span id="cb46-22"><a href="rendering.html#cb46-22" tabindex="-1"></a><span class="st">'&lt;span class="cf"&gt;function&lt;/span&gt;'</span>)</span><span id="cb46-23"><a href="rendering.html#cb46-23" tabindex="-1"></a><span class="co"># find functions that are defined in this file:</span></span><span id="cb46-24"><a href="rendering.html#cb46-24" tabindex="-1"></a>    function_names <span class="ot">&lt;-</span> <span class="fu">character</span>(<span class="dv">0</span>)</span><span id="cb46-25"><a href="rendering.html#cb46-25" tabindex="-1"></a><span class="cf">for</span> (pattern <span class="cf">in</span> <span class="fu">c</span>(pattern1, pattern2)) {</span><span id="cb46-26"><a href="rendering.html#cb46-26" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(start_line <span class="sc">+</span> <span class="dv">1</span>, <span class="fu">length</span>(txt))) {</span><span id="cb46-27"><a href="rendering.html#cb46-27" tabindex="-1"></a>        fn_name <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_match</span>(txt[i], pattern)[, <span class="dv">2</span>]</span><span id="cb46-28"><a href="rendering.html#cb46-28" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">is.na</span>(fn_name)) <span class="cf">next</span></span><span id="cb46-29"><a href="rendering.html#cb46-29" tabindex="-1"></a><span class="co"># a function was defined in this line, so put a span around it</span></span><span id="cb46-30"><a href="rendering.html#cb46-30" tabindex="-1"></a>        txt[i] <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(</span><span id="cb46-31"><a href="rendering.html#cb46-31" tabindex="-1"></a>          txt[i],</span><span id="cb46-32"><a href="rendering.html#cb46-32" tabindex="-1"></a>          pattern,</span><span id="cb46-33"><a href="rendering.html#cb46-33" tabindex="-1"></a>          stringr<span class="sc">::</span><span class="fu">str_glue</span>(<span class="st">"&lt;span id='{fn_name}'&gt;</span><span class="sc">\\</span><span class="st">1&lt;/span&gt;</span><span class="sc">\\</span><span class="st">2"</span>)</span><span id="cb46-34"><a href="rendering.html#cb46-34" tabindex="-1"></a>        )</span><span id="cb46-35"><a href="rendering.html#cb46-35" tabindex="-1"></a><span class="co"># and keep track of it for later:</span></span><span id="cb46-36"><a href="rendering.html#cb46-36" tabindex="-1"></a>        function_names <span class="ot">&lt;-</span> <span class="fu">c</span>(function_names, fn_name)</span><span id="cb46-37"><a href="rendering.html#cb46-37" tabindex="-1"></a>      }</span><span id="cb46-38"><a href="rendering.html#cb46-38" tabindex="-1"></a>    }</span><span id="cb46-39"><a href="rendering.html#cb46-39" tabindex="-1"></a><span class="fu">list</span>(<span class="at">function_names =</span> function_names, <span class="at">txt =</span> txt)</span><span id="cb46-40"><a href="rendering.html#cb46-40" tabindex="-1"></a>  }</span><span id="cb46-41"><a href="rendering.html#cb46-41" tabindex="-1"></a>  fdefs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(html_files, find_function_defs)</span><span id="cb46-42"><a href="rendering.html#cb46-42" tabindex="-1"></a>  all_function_names <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(fdefs, <span class="cf">function</span>(lst) lst<span class="sc">$</span>function_names))</span><span id="cb46-43"><a href="rendering.html#cb46-43" tabindex="-1"></a><span class="co"># if a function is defined multiple times, then it's ambiguous where to link to</span></span><span id="cb46-44"><a href="rendering.html#cb46-44" tabindex="-1"></a><span class="co"># so let's not try linking to it (this can occur when a function is defined </span></span><span id="cb46-45"><a href="rendering.html#cb46-45" tabindex="-1"></a><span class="co"># within a function, such as `new$<a href="rendering.html#post_processor">post_processor</a>()`)</span></span><span id="cb46-46"><a href="rendering.html#cb46-46" tabindex="-1"></a>  repeated <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">which</span>(<span class="fu">table</span>(all_function_names) <span class="sc">&gt;</span> <span class="dv">1</span>))</span><span id="cb46-47"><a href="rendering.html#cb46-47" tabindex="-1"></a>  all_function_names <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(all_function_names, repeated)</span><span id="cb46-48"><a href="rendering.html#cb46-48" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(all_function_names) <span class="sc">==</span> <span class="dv">0</span>) {</span><span id="cb46-49"><a href="rendering.html#cb46-49" tabindex="-1"></a><span class="co"># no functions defined in package, so nothing more to be done here</span></span><span id="cb46-50"><a href="rendering.html#cb46-50" tabindex="-1"></a><span class="fu">return</span>()</span><span id="cb46-51"><a href="rendering.html#cb46-51" tabindex="-1"></a>  }</span><span id="cb46-52"><a href="rendering.html#cb46-52" tabindex="-1"></a>  num_per_file <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(fdefs, </span><span id="cb46-53"><a href="rendering.html#cb46-53" tabindex="-1"></a><span class="cf">function</span>(lst) {</span><span id="cb46-54"><a href="rendering.html#cb46-54" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">setdiff</span>(lst<span class="sc">$</span>function_names, repeated))</span><span id="cb46-55"><a href="rendering.html#cb46-55" tabindex="-1"></a>                                }))</span><span id="cb46-56"><a href="rendering.html#cb46-56" tabindex="-1"></a>  where_defined <span class="ot">&lt;-</span> <span class="fu">rep</span>(fs<span class="sc">::</span><span class="fu">path_file</span>(html_files), <span class="at">times =</span> num_per_file)</span><span id="cb46-57"><a href="rendering.html#cb46-57" tabindex="-1"></a>  defined_functions_pattern <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"(::)?"</span>,all_function_names, <span class="st">"</span><span class="sc">\\</span><span class="st">("</span>, <span class="at">collapse =</span> <span class="st">"|"</span>)</span><span id="cb46-58"><a href="rendering.html#cb46-58" tabindex="-1"></a><span class="co"># There's also this case: &lt;span class="fu"&gt;myfunction&lt;/span&gt;</span></span><span id="cb46-59"><a href="rendering.html#cb46-59" tabindex="-1"></a>  defined_functions_pattern2 <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span><span id="cb46-60"><a href="rendering.html#cb46-60" tabindex="-1"></a><span class="st">'&lt;span class="fu"&gt;'</span>, all_function_names, <span class="st">'&lt;/span&gt;</span><span class="sc">\\</span><span class="st">('</span>,</span><span id="cb46-61"><a href="rendering.html#cb46-61" tabindex="-1"></a><span class="at">collapse =</span><span class="st">"|"</span>)</span><span id="cb46-62"><a href="rendering.html#cb46-62" tabindex="-1"></a></span><span id="cb46-63"><a href="rendering.html#cb46-63" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(html_files)) {</span><span id="cb46-64"><a href="rendering.html#cb46-64" tabindex="-1"></a><span class="co"># whenever one of the defined functions is named, link to its definition</span></span><span id="cb46-65"><a href="rendering.html#cb46-65" tabindex="-1"></a><span class="co"># using the format `file_where_foo_is_defined.html#foo`</span></span><span id="cb46-66"><a href="rendering.html#cb46-66" tabindex="-1"></a>    modified_txt <span class="ot">&lt;-</span> <a href="rendering.html#insert_hrefs">insert_hrefs</a>(fdefs[[i]]<span class="sc">$</span>txt, defined_functions_pattern,</span><span id="cb46-67"><a href="rendering.html#cb46-67" tabindex="-1"></a>                                 where_defined, all_function_names, pkg_name)</span><span id="cb46-68"><a href="rendering.html#cb46-68" tabindex="-1"></a>    modified_txt <span class="ot">&lt;-</span> <a href="rendering.html#insert_hrefs">insert_hrefs</a>(modified_txt, defined_functions_pattern2,</span><span id="cb46-69"><a href="rendering.html#cb46-69" tabindex="-1"></a>                                 where_defined, all_function_names, pkg_name, <span class="at">remove_span=</span><span class="cn">TRUE</span>)</span><span id="cb46-70"><a href="rendering.html#cb46-70" tabindex="-1"></a><span class="fu">writeLines</span>(modified_txt, <span class="at">con =</span> html_files[i])</span><span id="cb46-71"><a href="rendering.html#cb46-71" tabindex="-1"></a>  }</span><span id="cb46-72"><a href="rendering.html#cb46-72" tabindex="-1"></a>}</span></code></pre>
<legend class="chunklegend">foo</legend>
</fieldset></div>
<p>We define next the helper function <code>insert_hrefs()</code>, which was called in the previous function. If the function <code>foo()</code> is defined in the .Rmd file that defines a package named <code>pkg</code>, then whenever <code>foo()</code> or <code>pkg::foo()</code> appears in the .Rmd, a link will be added; however, if <code>other_pkg::foo()</code> appears, then no link will be added.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="rendering.html#cb47-1" tabindex="-1"></a><span class="co">#' Replace a function's name with a link to its definition</span></span>
<span id="cb47-2"><a href="rendering.html#cb47-2" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb47-3"><a href="rendering.html#cb47-3" tabindex="-1"></a><span class="co">#' A helper function for `add_function_hyperlinks` that wraps references to a </span></span>
<span id="cb47-4"><a href="rendering.html#cb47-4" tabindex="-1"></a><span class="co">#' function in an anchor tag with a link to the function's definition.</span></span>
<span id="cb47-5"><a href="rendering.html#cb47-5" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb47-6"><a href="rendering.html#cb47-6" tabindex="-1"></a><span class="co">#' @param txt Character vector where each element is a row of the knitted HTML file.</span></span>
<span id="cb47-7"><a href="rendering.html#cb47-7" tabindex="-1"></a><span class="co">#' @param function_pattern Regular Expression passed from `add_function_hyperlinks` that contains all referenced functions in the document.</span></span>
<span id="cb47-8"><a href="rendering.html#cb47-8" tabindex="-1"></a><span class="co">#' @param where_defined Character vector that contains the name of the file in which a function was defined.</span></span>
<span id="cb47-9"><a href="rendering.html#cb47-9" tabindex="-1"></a><span class="co">#' @param all_function_names Character vector of all referenced functions in the document.</span></span>
<span id="cb47-10"><a href="rendering.html#cb47-10" tabindex="-1"></a><span class="co">#' @param pkg_name Name of the package created by litr. Taken from YAML front matter.</span></span>
<span id="cb47-11"><a href="rendering.html#cb47-11" tabindex="-1"></a><span class="co">#' @param remove_span Boolean argument for removing span tags. Used for minimizing code duplication.</span></span>
<span id="cb47-12"><a href="rendering.html#cb47-12" tabindex="-1"></a><span class="co">#' @keywords internal</span></span>
<span id="cb47-13"><a href="rendering.html#cb47-13" tabindex="-1"></a><span id="insert_hrefs">insert_hrefs</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(txt, function_pattern, where_defined,</span>
<span id="cb47-14"><a href="rendering.html#cb47-14" tabindex="-1"></a>                         all_function_names, pkg_name, <span class="at">remove_span=</span><span class="cn">FALSE</span>){</span>
<span id="cb47-15"><a href="rendering.html#cb47-15" tabindex="-1"></a>  <span class="co"># filter down matches of defined_functions_pattern</span></span>
<span id="cb47-16"><a href="rendering.html#cb47-16" tabindex="-1"></a>  has_fn_name <span class="ot">&lt;-</span> <span class="fu">which</span>(stringr<span class="sc">::</span><span class="fu">str_detect</span>(txt, function_pattern))</span>
<span id="cb47-17"><a href="rendering.html#cb47-17" tabindex="-1"></a>  has_colon_prefix <span class="ot">&lt;-</span> <span class="fu">which</span>(stringr<span class="sc">::</span><span class="fu">str_detect</span>(txt, <span class="fu">paste0</span>(<span class="st">"::"</span>, all_function_names, <span class="st">"</span><span class="sc">\\</span><span class="st">("</span>, <span class="at">collapse =</span> <span class="st">"|"</span>)))</span>
<span id="cb47-18"><a href="rendering.html#cb47-18" tabindex="-1"></a>  has_only_fn_name <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(has_fn_name, has_colon_prefix)</span>
<span id="cb47-19"><a href="rendering.html#cb47-19" tabindex="-1"></a>  has_pkg_colon_prefix <span class="ot">&lt;-</span> <span class="fu">which</span>(stringr<span class="sc">::</span><span class="fu">str_detect</span>(txt, <span class="fu">paste0</span>(stringr<span class="sc">::</span><span class="fu">str_glue</span>(<span class="st">"{pkg_name}::"</span>))))</span>
<span id="cb47-20"><a href="rendering.html#cb47-20" tabindex="-1"></a>  </span>
<span id="cb47-21"><a href="rendering.html#cb47-21" tabindex="-1"></a>  <span class="co"># define different replacement functions for colon prefix cases and regular cases</span></span>
<span id="cb47-22"><a href="rendering.html#cb47-22" tabindex="-1"></a>  <span id="colon_pref_replace_fn">colon_pref_replace_fn</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb47-23"><a href="rendering.html#cb47-23" tabindex="-1"></a>    <span class="cf">if</span>(remove_span){</span>
<span id="cb47-24"><a href="rendering.html#cb47-24" tabindex="-1"></a>      fn_name <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_remove</span>(x, <span class="st">"&lt;/span&gt;</span><span class="sc">\\</span><span class="st">("</span>)</span>
<span id="cb47-25"><a href="rendering.html#cb47-25" tabindex="-1"></a>      fn_name <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_remove</span>(fn_name, <span class="st">'&lt;span class="fu"&gt;'</span>)</span>
<span id="cb47-26"><a href="rendering.html#cb47-26" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="cb47-27"><a href="rendering.html#cb47-27" tabindex="-1"></a>      fn_name <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_remove</span>(x, <span class="st">"</span><span class="sc">\\</span><span class="st">("</span>)</span>
<span id="cb47-28"><a href="rendering.html#cb47-28" tabindex="-1"></a>    }</span>
<span id="cb47-29"><a href="rendering.html#cb47-29" tabindex="-1"></a>    fn_name <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_remove</span>(fn_name, stringr<span class="sc">::</span><span class="fu">str_glue</span>(<span class="st">'{pkg_name}::'</span>))</span>
<span id="cb47-30"><a href="rendering.html#cb47-30" tabindex="-1"></a>    <span class="co"># implicitly assuming that a function is not redefined in another file</span></span>
<span id="cb47-31"><a href="rendering.html#cb47-31" tabindex="-1"></a>    def_file <span class="ot">&lt;-</span> where_defined[all_function_names <span class="sc">==</span> fn_name]</span>
<span id="cb47-32"><a href="rendering.html#cb47-32" tabindex="-1"></a>    <span class="fu">return</span>(stringr<span class="sc">::</span><span class="fu">str_glue</span>(<span class="st">"{pkg_name}::&lt;a href='{def_file}#{fn_name}'&gt;{fn_name}&lt;/a&gt;("</span>))</span>
<span id="cb47-33"><a href="rendering.html#cb47-33" tabindex="-1"></a>    </span>
<span id="cb47-34"><a href="rendering.html#cb47-34" tabindex="-1"></a>  }</span>
<span id="cb47-35"><a href="rendering.html#cb47-35" tabindex="-1"></a>  <span id="regular_replace_fn">regular_replace_fn</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb47-36"><a href="rendering.html#cb47-36" tabindex="-1"></a>    <span class="cf">if</span>(remove_span){</span>
<span id="cb47-37"><a href="rendering.html#cb47-37" tabindex="-1"></a>      fn_name <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_remove</span>(x, <span class="st">'&lt;/span&gt;</span><span class="sc">\\</span><span class="st">('</span>)</span>
<span id="cb47-38"><a href="rendering.html#cb47-38" tabindex="-1"></a>      fn_name <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_remove</span>(fn_name, <span class="st">'&lt;span class="fu"&gt;'</span>)  </span>
<span id="cb47-39"><a href="rendering.html#cb47-39" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb47-40"><a href="rendering.html#cb47-40" tabindex="-1"></a>      fn_name <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_remove</span>(x, <span class="st">"</span><span class="sc">\\</span><span class="st">("</span>)</span>
<span id="cb47-41"><a href="rendering.html#cb47-41" tabindex="-1"></a>    }</span>
<span id="cb47-42"><a href="rendering.html#cb47-42" tabindex="-1"></a>    <span class="co"># implicitly assuming that a function is not redefined in another file</span></span>
<span id="cb47-43"><a href="rendering.html#cb47-43" tabindex="-1"></a>    def_file <span class="ot">&lt;-</span> where_defined[all_function_names <span class="sc">==</span> fn_name]</span>
<span id="cb47-44"><a href="rendering.html#cb47-44" tabindex="-1"></a>    stringr<span class="sc">::</span><span class="fu">str_glue</span>(<span class="st">"&lt;a href='{def_file}#{fn_name}'&gt;{fn_name}&lt;/a&gt;("</span>)</span>
<span id="cb47-45"><a href="rendering.html#cb47-45" tabindex="-1"></a>  }  </span>
<span id="cb47-46"><a href="rendering.html#cb47-46" tabindex="-1"></a>  </span>
<span id="cb47-47"><a href="rendering.html#cb47-47" tabindex="-1"></a>  colon_prefix_function_pattern <span class="ot">&lt;-</span> <span class="fu">paste0</span>(stringr<span class="sc">::</span><span class="fu">str_glue</span>(<span class="st">"{pkg_name}::"</span>),all_function_names, <span class="st">"</span><span class="sc">\\</span><span class="st">("</span>, <span class="at">collapse =</span> <span class="st">"|"</span>)</span>
<span id="cb47-48"><a href="rendering.html#cb47-48" tabindex="-1"></a>  colon_prefix_refs <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(</span>
<span id="cb47-49"><a href="rendering.html#cb47-49" tabindex="-1"></a>    txt[has_pkg_colon_prefix],</span>
<span id="cb47-50"><a href="rendering.html#cb47-50" tabindex="-1"></a>    colon_prefix_function_pattern,</span>
<span id="cb47-51"><a href="rendering.html#cb47-51" tabindex="-1"></a>    colon_pref_replace_fn</span>
<span id="cb47-52"><a href="rendering.html#cb47-52" tabindex="-1"></a>  )</span>
<span id="cb47-53"><a href="rendering.html#cb47-53" tabindex="-1"></a>  </span>
<span id="cb47-54"><a href="rendering.html#cb47-54" tabindex="-1"></a>  regular_refs <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(</span>
<span id="cb47-55"><a href="rendering.html#cb47-55" tabindex="-1"></a>    txt[has_only_fn_name],</span>
<span id="cb47-56"><a href="rendering.html#cb47-56" tabindex="-1"></a>    function_pattern,</span>
<span id="cb47-57"><a href="rendering.html#cb47-57" tabindex="-1"></a>    regular_replace_fn</span>
<span id="cb47-58"><a href="rendering.html#cb47-58" tabindex="-1"></a>  )</span>
<span id="cb47-59"><a href="rendering.html#cb47-59" tabindex="-1"></a>  <span class="co"># now put back in the changed lines</span></span>
<span id="cb47-60"><a href="rendering.html#cb47-60" tabindex="-1"></a>  txt[has_pkg_colon_prefix] <span class="ot">&lt;-</span> colon_prefix_refs</span>
<span id="cb47-61"><a href="rendering.html#cb47-61" tabindex="-1"></a>  txt[has_only_fn_name] <span class="ot">&lt;-</span> regular_refs</span>
<span id="cb47-62"><a href="rendering.html#cb47-62" tabindex="-1"></a>  txt</span>
<span id="cb47-63"><a href="rendering.html#cb47-63" tabindex="-1"></a>}</span></code></pre></div>
<p>In addition to adding hyperlinks to function definitions, we also want to add hyperlinks for chunk references of the form <code>&lt;&lt;chunk-name&gt;&gt;</code> that link to user-defined chunk names that take the form <code>###chunk-name###</code>. We want these user-defined chunk names to stand out to readers and in their original form as code comments they might be harder to notice. To solve this issue, we modify the formatting of these chunks to add a border with the name of the chunk set into the border, mimicking the look of a <code>&lt;fieldset&gt;</code> tag. The additional formatting requires inserting additional HTML tags as well as css into the knitted HTML file so we use the <code>xml2</code> package to parse and manipulate the knitted HTML file.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="rendering.html#cb48-1" tabindex="-1"></a><span class="co">#' Add hyperlinks to embedded chunks</span></span>
<span id="cb48-2"><a href="rendering.html#cb48-2" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb48-3"><a href="rendering.html#cb48-3" tabindex="-1"></a><span class="co">#' Finds chunks that are referenced in the html file(s) by looking for comments</span></span>
<span id="cb48-4"><a href="rendering.html#cb48-4" tabindex="-1"></a><span class="co">#' of the form `<span id="foo">###"foo"###</span>` and then wraps `foo` in a `span` tag with `id="foo"` </span></span>
<span id="cb48-5"><a href="rendering.html#cb48-5" tabindex="-1"></a><span class="co">#' and then whenever the chunk label `<a href="rendering.html#foo">&lt;&lt;foo&gt;&gt;</a>` is found it wraps it in a </span></span>
<span id="cb48-6"><a href="rendering.html#cb48-6" tabindex="-1"></a><span class="co">#' `a href="file.html#foo"` tag so that it will be a hyperlink to `foo`'s </span></span>
<span id="cb48-7"><a href="rendering.html#cb48-7" tabindex="-1"></a><span class="co">#' definition.</span></span>
<span id="cb48-8"><a href="rendering.html#cb48-8" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb48-9"><a href="rendering.html#cb48-9" tabindex="-1"></a><span class="co">#' @param html_files Character vector of file names of html files that were created</span></span>
<span id="cb48-10"><a href="rendering.html#cb48-10" tabindex="-1"></a><span class="co">#' from Rmd files</span></span>
<span id="cb48-11"><a href="rendering.html#cb48-11" tabindex="-1"></a><span class="co">#' @param reference_start The delimiter used to indicate the start of a chunk label </span></span>
<span id="cb48-12"><a href="rendering.html#cb48-12" tabindex="-1"></a><span class="co">#' @param reference_end The delimiter used to indicate the end of a chunk label </span></span>
<span id="cb48-13"><a href="rendering.html#cb48-13" tabindex="-1"></a><span class="co">#' @keywords internal</span></span>
<span id="cb48-14"><a href="rendering.html#cb48-14" tabindex="-1"></a><span id="add_chunk_label_hyperlinks">add_chunk_label_hyperlinks</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(html_files,</span>
<span id="cb48-15"><a href="rendering.html#cb48-15" tabindex="-1"></a>                                       <span class="at">reference_start =</span> <span class="st">"&amp;lt;&amp;lt;"</span>,</span>
<span id="cb48-16"><a href="rendering.html#cb48-16" tabindex="-1"></a>                                       <span class="at">reference_end =</span> <span class="st">"&amp;gt;&amp;gt;"</span>){</span>
<span id="cb48-17"><a href="rendering.html#cb48-17" tabindex="-1"></a>  <span id="find_chunk_defs">find_chunk_defs</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(html_file) {</span>
<span id="cb48-18"><a href="rendering.html#cb48-18" tabindex="-1"></a>    txt <span class="ot">&lt;-</span> <span class="fu">readLines</span>(html_file)</span>
<span id="cb48-19"><a href="rendering.html#cb48-19" tabindex="-1"></a>    start_line <span class="ot">&lt;-</span> <span class="fu">which</span>(txt <span class="sc">==</span> <span class="st">"&lt;body&gt;"</span>)</span>
<span id="cb48-20"><a href="rendering.html#cb48-20" tabindex="-1"></a>    pattern <span class="ot">&lt;-</span> <span class="st">'###&amp;quot;([a-zA-Z0-9-_.]+)&amp;quot;###'</span></span>
<span id="cb48-21"><a href="rendering.html#cb48-21" tabindex="-1"></a>    <span class="co"># find chunks that are defined in this file:</span></span>
<span id="cb48-22"><a href="rendering.html#cb48-22" tabindex="-1"></a>    chunk_names <span class="ot">&lt;-</span> <span class="fu">character</span>(<span class="dv">0</span>)</span>
<span id="cb48-23"><a href="rendering.html#cb48-23" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(start_line <span class="sc">+</span> <span class="dv">1</span>, <span class="fu">length</span>(txt))) {</span>
<span id="cb48-24"><a href="rendering.html#cb48-24" tabindex="-1"></a>      chunk_name <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_match</span>(txt[i], pattern)[, <span class="dv">2</span>]</span>
<span id="cb48-25"><a href="rendering.html#cb48-25" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">is.na</span>(chunk_name)) <span class="cf">next</span></span>
<span id="cb48-26"><a href="rendering.html#cb48-26" tabindex="-1"></a>      <span class="co"># a chunk was defined in this line, so put a span around it</span></span>
<span id="cb48-27"><a href="rendering.html#cb48-27" tabindex="-1"></a>      txt[i] <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(</span>
<span id="cb48-28"><a href="rendering.html#cb48-28" tabindex="-1"></a>        txt[i],</span>
<span id="cb48-29"><a href="rendering.html#cb48-29" tabindex="-1"></a>        pattern,</span>
<span id="cb48-30"><a href="rendering.html#cb48-30" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_glue</span>(<span class="st">"&lt;span id='{chunk_name}'&gt;###&amp;quot;</span><span class="sc">\\</span><span class="st">1&amp;quot;###&lt;/span&gt;"</span>)</span>
<span id="cb48-31"><a href="rendering.html#cb48-31" tabindex="-1"></a>      )</span>
<span id="cb48-32"><a href="rendering.html#cb48-32" tabindex="-1"></a>      <span class="co"># and keep track of it for later.</span></span>
<span id="cb48-33"><a href="rendering.html#cb48-33" tabindex="-1"></a>      <span class="co"># we're using setNames here to make sure that we keep the name of file</span></span>
<span id="cb48-34"><a href="rendering.html#cb48-34" tabindex="-1"></a>      <span class="co"># where the chunk name is defined </span></span>
<span id="cb48-35"><a href="rendering.html#cb48-35" tabindex="-1"></a>      chunk_names <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">c</span>(chunk_names, chunk_name), <span class="fu">c</span>(<span class="fu">names</span>(chunk_names), html_file))</span>
<span id="cb48-36"><a href="rendering.html#cb48-36" tabindex="-1"></a>    }</span>
<span id="cb48-37"><a href="rendering.html#cb48-37" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">chunk_names =</span> chunk_names, <span class="at">txt =</span> txt)</span>
<span id="cb48-38"><a href="rendering.html#cb48-38" tabindex="-1"></a>  }</span>
<span id="cb48-39"><a href="rendering.html#cb48-39" tabindex="-1"></a>  </span>
<span id="cb48-40"><a href="rendering.html#cb48-40" tabindex="-1"></a>  cdefs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(html_files, find_chunk_defs)</span>
<span id="cb48-41"><a href="rendering.html#cb48-41" tabindex="-1"></a>  all_chunk_names <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(cdefs, <span class="cf">function</span>(lst) lst<span class="sc">$</span>chunk_names))</span>
<span id="cb48-42"><a href="rendering.html#cb48-42" tabindex="-1"></a>  num_per_file <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(cdefs, <span class="cf">function</span>(lst) <span class="fu">length</span>(lst<span class="sc">$</span>chunk_names)))</span>
<span id="cb48-43"><a href="rendering.html#cb48-43" tabindex="-1"></a>  where_defined <span class="ot">&lt;-</span> <span class="fu">rep</span>(fs<span class="sc">::</span><span class="fu">path_file</span>(html_files), <span class="at">times =</span> num_per_file)</span>
<span id="cb48-44"><a href="rendering.html#cb48-44" tabindex="-1"></a>  </span>
<span id="cb48-45"><a href="rendering.html#cb48-45" tabindex="-1"></a>  defined_chunks_pattern <span class="ot">&lt;-</span> <span class="fu">paste0</span>(reference_start, all_chunk_names, reference_end, </span>
<span id="cb48-46"><a href="rendering.html#cb48-46" tabindex="-1"></a>                                   <span class="at">collapse =</span> <span class="st">"|"</span>)</span>
<span id="cb48-47"><a href="rendering.html#cb48-47" tabindex="-1"></a>  ref_start <span class="ot">&lt;-</span> <span class="st">'&lt;span class="sc"&gt;&amp;lt;&lt;/span&gt;&lt;span class="er"&gt;&amp;lt;&lt;/span&gt;'</span></span>
<span id="cb48-48"><a href="rendering.html#cb48-48" tabindex="-1"></a>  ref_start_alt <span class="ot">&lt;-</span> <span class="st">'&lt;span class=</span><span class="sc">\"</span><span class="st">er</span><span class="sc">\"</span><span class="st">&gt;&amp;lt;&amp;lt;&lt;/span&gt;'</span></span>
<span id="cb48-49"><a href="rendering.html#cb48-49" tabindex="-1"></a>  ref_end <span class="ot">&lt;-</span> <span class="st">'&lt;span class="sc"&gt;&amp;gt;&lt;/span&gt;&lt;span class="er"&gt;&amp;gt;&lt;/span&gt;'</span></span>
<span id="cb48-50"><a href="rendering.html#cb48-50" tabindex="-1"></a>  hyphen_with_extras <span class="ot">&lt;-</span> <span class="st">'&lt;span class="sc"&gt;-&lt;/span&gt;'</span></span>
<span id="cb48-51"><a href="rendering.html#cb48-51" tabindex="-1"></a>  all_chunk_names2 <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(all_chunk_names, <span class="st">"-"</span>, hyphen_with_extras)</span>
<span id="cb48-52"><a href="rendering.html#cb48-52" tabindex="-1"></a>  defined_chunks_pattern2 <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb48-53"><a href="rendering.html#cb48-53" tabindex="-1"></a>    ref_start, all_chunk_names2, ref_end, <span class="at">collapse =</span> <span class="st">"|"</span></span>
<span id="cb48-54"><a href="rendering.html#cb48-54" tabindex="-1"></a>  )</span>
<span id="cb48-55"><a href="rendering.html#cb48-55" tabindex="-1"></a>  defined_chunks_pattern2_alt <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb48-56"><a href="rendering.html#cb48-56" tabindex="-1"></a>    ref_start_alt, all_chunk_names2, ref_end, <span class="at">collapse =</span> <span class="st">"|"</span></span>
<span id="cb48-57"><a href="rendering.html#cb48-57" tabindex="-1"></a>  )</span>
<span id="cb48-58"><a href="rendering.html#cb48-58" tabindex="-1"></a>  defined_chunks_pattern2 <span class="ot">&lt;-</span> <span class="fu">paste</span>(</span>
<span id="cb48-59"><a href="rendering.html#cb48-59" tabindex="-1"></a>    defined_chunks_pattern2, defined_chunks_pattern2_alt, <span class="at">sep =</span> <span class="st">"|"</span></span>
<span id="cb48-60"><a href="rendering.html#cb48-60" tabindex="-1"></a>  )</span>
<span id="cb48-61"><a href="rendering.html#cb48-61" tabindex="-1"></a>  </span>
<span id="cb48-62"><a href="rendering.html#cb48-62" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(html_files)) {</span>
<span id="cb48-63"><a href="rendering.html#cb48-63" tabindex="-1"></a>    <span class="co"># whenever one of these named chunks is referenced, link to its definition</span></span>
<span id="cb48-64"><a href="rendering.html#cb48-64" tabindex="-1"></a>    <span class="co"># using the format `file_where_chunk_is_defined.html#chunkname`</span></span>
<span id="cb48-65"><a href="rendering.html#cb48-65" tabindex="-1"></a>    txt <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(</span>
<span id="cb48-66"><a href="rendering.html#cb48-66" tabindex="-1"></a>      cdefs[[i]]<span class="sc">$</span>txt,</span>
<span id="cb48-67"><a href="rendering.html#cb48-67" tabindex="-1"></a>      defined_chunks_pattern,</span>
<span id="cb48-68"><a href="rendering.html#cb48-68" tabindex="-1"></a>      <span class="cf">function</span>(x) {</span>
<span id="cb48-69"><a href="rendering.html#cb48-69" tabindex="-1"></a>        cname <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(</span>
<span id="cb48-70"><a href="rendering.html#cb48-70" tabindex="-1"></a>          x,</span>
<span id="cb48-71"><a href="rendering.html#cb48-71" tabindex="-1"></a>          <span class="fu">paste</span>(reference_start, reference_end, <span class="at">sep =</span> <span class="st">"|"</span>)</span>
<span id="cb48-72"><a href="rendering.html#cb48-72" tabindex="-1"></a>        )</span>
<span id="cb48-73"><a href="rendering.html#cb48-73" tabindex="-1"></a>        def_file <span class="ot">&lt;-</span> where_defined[all_chunk_names <span class="sc">==</span> cname]</span>
<span id="cb48-74"><a href="rendering.html#cb48-74" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_glue</span>(</span>
<span id="cb48-75"><a href="rendering.html#cb48-75" tabindex="-1"></a>          <span class="st">"&lt;a href='{def_file}#{cname}'&gt;{reference_start}{cname}{reference_end}&lt;/a&gt;"</span></span>
<span id="cb48-76"><a href="rendering.html#cb48-76" tabindex="-1"></a>        )</span>
<span id="cb48-77"><a href="rendering.html#cb48-77" tabindex="-1"></a>      }</span>
<span id="cb48-78"><a href="rendering.html#cb48-78" tabindex="-1"></a>    )</span>
<span id="cb48-79"><a href="rendering.html#cb48-79" tabindex="-1"></a>    txt <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(</span>
<span id="cb48-80"><a href="rendering.html#cb48-80" tabindex="-1"></a>      txt,</span>
<span id="cb48-81"><a href="rendering.html#cb48-81" tabindex="-1"></a>      defined_chunks_pattern2,</span>
<span id="cb48-82"><a href="rendering.html#cb48-82" tabindex="-1"></a>      <span class="cf">function</span>(x) {</span>
<span id="cb48-83"><a href="rendering.html#cb48-83" tabindex="-1"></a>        cname <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(</span>
<span id="cb48-84"><a href="rendering.html#cb48-84" tabindex="-1"></a>          x,</span>
<span id="cb48-85"><a href="rendering.html#cb48-85" tabindex="-1"></a>          <span class="fu">paste</span>(ref_start, ref_start_alt, ref_end, <span class="at">sep =</span> <span class="st">"|"</span>)</span>
<span id="cb48-86"><a href="rendering.html#cb48-86" tabindex="-1"></a>        )</span>
<span id="cb48-87"><a href="rendering.html#cb48-87" tabindex="-1"></a>        def_file <span class="ot">&lt;-</span> where_defined[all_chunk_names2 <span class="sc">==</span> cname]</span>
<span id="cb48-88"><a href="rendering.html#cb48-88" tabindex="-1"></a>        cname <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(cname, hyphen_with_extras, <span class="st">"-"</span>)</span>
<span id="cb48-89"><a href="rendering.html#cb48-89" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_glue</span>(</span>
<span id="cb48-90"><a href="rendering.html#cb48-90" tabindex="-1"></a>          <span class="st">"&lt;a href='{def_file}#{cname}'&gt;{reference_start}{cname}{reference_end}&lt;/a&gt;"</span></span>
<span id="cb48-91"><a href="rendering.html#cb48-91" tabindex="-1"></a>        )</span>
<span id="cb48-92"><a href="rendering.html#cb48-92" tabindex="-1"></a>      }</span>
<span id="cb48-93"><a href="rendering.html#cb48-93" tabindex="-1"></a>    )</span>
<span id="cb48-94"><a href="rendering.html#cb48-94" tabindex="-1"></a>    </span>
<span id="cb48-95"><a href="rendering.html#cb48-95" tabindex="-1"></a>    parsed_html <span class="ot">&lt;-</span> xml2<span class="sc">::</span><span class="fu">read_html</span>(<span class="fu">paste</span>(txt,<span class="at">collapse=</span><span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb48-96"><a href="rendering.html#cb48-96" tabindex="-1"></a>    <span class="co"># get all possible chunk names in this file.</span></span>
<span id="cb48-97"><a href="rendering.html#cb48-97" tabindex="-1"></a>    chunk_names <span class="ot">&lt;-</span> all_chunk_names[<span class="fu">which</span>(<span class="fu">names</span>(all_chunk_names) <span class="sc">==</span> html_files[i])]</span>
<span id="cb48-98"><a href="rendering.html#cb48-98" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(chunk_names) <span class="sc">&gt;</span> <span class="dv">0</span>){</span>
<span id="cb48-99"><a href="rendering.html#cb48-99" tabindex="-1"></a>      <span class="cf">for</span>(j <span class="cf">in</span> <span class="fu">seq_along</span>(chunk_names)){</span>
<span id="cb48-100"><a href="rendering.html#cb48-100" tabindex="-1"></a>        <span class="co"># find the inner span node with the correct id</span></span>
<span id="cb48-101"><a href="rendering.html#cb48-101" tabindex="-1"></a>        span_node <span class="ot">&lt;-</span> xml2<span class="sc">::</span><span class="fu">xml_find_first</span>(parsed_html, stringr<span class="sc">::</span><span class="fu">str_glue</span>(<span class="st">'(.//span[@id="{chunk_names[j]}"])'</span>))</span>
<span id="cb48-102"><a href="rendering.html#cb48-102" tabindex="-1"></a>        span_node_path <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_split</span>(xml2<span class="sc">::</span><span class="fu">xml_path</span>(span_node),<span class="st">"/"</span>)</span>
<span id="cb48-103"><a href="rendering.html#cb48-103" tabindex="-1"></a>        <span class="co"># get the path for the pre tag which should be unaffected by the removal of the outer span</span></span>
<span id="cb48-104"><a href="rendering.html#cb48-104" tabindex="-1"></a>        pre_path <span class="ot">&lt;-</span> <span class="fu">paste</span>(span_node_path[[<span class="dv">1</span>]][<span class="dv">1</span><span class="sc">:</span>(<span class="fu">max</span>(<span class="fu">which</span>(stringr<span class="sc">::</span><span class="fu">str_detect</span>(span_node_path[[<span class="dv">1</span>]], <span class="st">"pre"</span>))))],<span class="at">collapse=</span><span class="st">"/"</span>)</span>
<span id="cb48-105"><a href="rendering.html#cb48-105" tabindex="-1"></a>        <span class="co"># get the path for the span that wraps around it</span></span>
<span id="cb48-106"><a href="rendering.html#cb48-106" tabindex="-1"></a>        outer_span_path <span class="ot">&lt;-</span> <span class="fu">paste</span>(span_node_path[[<span class="dv">1</span>]][<span class="dv">1</span><span class="sc">:</span><span class="fu">min</span>(<span class="fu">which</span>(stringr<span class="sc">::</span><span class="fu">str_detect</span>(span_node_path[[<span class="dv">1</span>]], <span class="st">"span"</span>)))], <span class="at">collapse=</span><span class="st">"/"</span>)</span>
<span id="cb48-107"><a href="rendering.html#cb48-107" tabindex="-1"></a>        <span class="co"># find that node and remove it from the tree</span></span>
<span id="cb48-108"><a href="rendering.html#cb48-108" tabindex="-1"></a>        outer_span_node <span class="ot">&lt;-</span> xml2<span class="sc">::</span><span class="fu">xml_find_first</span>(parsed_html, outer_span_path)</span>
<span id="cb48-109"><a href="rendering.html#cb48-109" tabindex="-1"></a>        xml2<span class="sc">::</span><span class="fu">xml_remove</span>(outer_span_node)</span>
<span id="cb48-110"><a href="rendering.html#cb48-110" tabindex="-1"></a>        </span>
<span id="cb48-111"><a href="rendering.html#cb48-111" tabindex="-1"></a>        </span>
<span id="cb48-112"><a href="rendering.html#cb48-112" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">nchar</span>(pre_path) <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb48-113"><a href="rendering.html#cb48-113" tabindex="-1"></a>          <span class="cf">next</span>()</span>
<span id="cb48-114"><a href="rendering.html#cb48-114" tabindex="-1"></a>        }</span>
<span id="cb48-115"><a href="rendering.html#cb48-115" tabindex="-1"></a>        pre_parent <span class="ot">&lt;-</span> xml2<span class="sc">::</span><span class="fu">xml_find_first</span>(parsed_html, pre_path)</span>
<span id="cb48-116"><a href="rendering.html#cb48-116" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">is.na</span>(pre_parent)){</span>
<span id="cb48-117"><a href="rendering.html#cb48-117" tabindex="-1"></a>          <span class="cf">next</span>()</span>
<span id="cb48-118"><a href="rendering.html#cb48-118" tabindex="-1"></a>        }</span>
<span id="cb48-119"><a href="rendering.html#cb48-119" tabindex="-1"></a>        </span>
<span id="cb48-120"><a href="rendering.html#cb48-120" tabindex="-1"></a>        </span>
<span id="cb48-121"><a href="rendering.html#cb48-121" tabindex="-1"></a>        xml2<span class="sc">::</span><span class="fu">xml_add_parent</span>(pre_parent, xml2<span class="sc">::</span><span class="fu">read_xml</span>(stringr<span class="sc">::</span><span class="fu">str_glue</span>(<span class="st">'&lt;fieldset id="{chunk_names[j]}" class="chunkfield"&gt; &lt;/fieldset&gt;'</span>)))</span>
<span id="cb48-122"><a href="rendering.html#cb48-122" tabindex="-1"></a>        xml2<span class="sc">::</span><span class="fu">xml_add_sibling</span>(pre_parent, xml2<span class="sc">::</span><span class="fu">read_xml</span>(stringr<span class="sc">::</span><span class="fu">str_glue</span>(<span class="st">'&lt;legend class="chunklegend"&gt;{chunk_names[j]}&lt;/legend&gt;'</span>)), <span class="at">where=</span><span class="st">"before"</span>)</span>
<span id="cb48-123"><a href="rendering.html#cb48-123" tabindex="-1"></a>        <span class="co"># remove the extra line break that is left over from removing the span</span></span>
<span id="cb48-124"><a href="rendering.html#cb48-124" tabindex="-1"></a>        code_node <span class="ot">&lt;-</span> xml2<span class="sc">::</span><span class="fu">xml_child</span>(pre_parent)</span>
<span id="cb48-125"><a href="rendering.html#cb48-125" tabindex="-1"></a>        code_node_contents <span class="ot">&lt;-</span> xml2<span class="sc">::</span><span class="fu">xml_contents</span>(code_node)</span>
<span id="cb48-126"><a href="rendering.html#cb48-126" tabindex="-1"></a>        <span class="cf">if</span>(xml2<span class="sc">::</span><span class="fu">xml_text</span>(code_node_contents[[<span class="dv">1</span>]]) <span class="sc">==</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>){</span>
<span id="cb48-127"><a href="rendering.html#cb48-127" tabindex="-1"></a>          xml2<span class="sc">::</span><span class="fu">xml_remove</span>(code_node_contents[[<span class="dv">1</span>]])  </span>
<span id="cb48-128"><a href="rendering.html#cb48-128" tabindex="-1"></a>        }</span>
<span id="cb48-129"><a href="rendering.html#cb48-129" tabindex="-1"></a>      }</span>
<span id="cb48-130"><a href="rendering.html#cb48-130" tabindex="-1"></a>    }</span>
<span id="cb48-131"><a href="rendering.html#cb48-131" tabindex="-1"></a>    <span class="co"># last thing is to insert an additional style node in the head with our CSS so we have a standard style whether we are using bookdown or Rmarkdown</span></span>
<span id="cb48-132"><a href="rendering.html#cb48-132" tabindex="-1"></a>    css_string <span class="ot">&lt;-</span> <span class="st">"fieldset.chunkfield {border:1px dotted black;padding-bottom: 0px;padding-top: 0px;margin:0 2px;padding:.35em .625em .75em}</span></span>
<span id="cb48-133"><a href="rendering.html#cb48-133" tabindex="-1"></a><span class="st">                   legend.chunklegend {padding:0;width:auto;border:0; border-bottom: none; margin-bottom:0}"</span></span>
<span id="cb48-134"><a href="rendering.html#cb48-134" tabindex="-1"></a>    head_node <span class="ot">&lt;-</span> xml2<span class="sc">::</span><span class="fu">xml_find_first</span>(parsed_html, <span class="st">".//head"</span>)</span>
<span id="cb48-135"><a href="rendering.html#cb48-135" tabindex="-1"></a>    xml2<span class="sc">::</span><span class="fu">xml_add_child</span>(head_node, xml2<span class="sc">::</span><span class="fu">read_xml</span>(stringr<span class="sc">::</span><span class="fu">str_glue</span>(<span class="st">"&lt;style type='text/css'&gt;{css_string}&lt;/style&gt;"</span>)))</span>
<span id="cb48-136"><a href="rendering.html#cb48-136" tabindex="-1"></a>    txt <span class="ot">&lt;-</span> xml2<span class="sc">::</span><span class="fu">write_html</span>(parsed_html, html_files[i])</span>
<span id="cb48-137"><a href="rendering.html#cb48-137" tabindex="-1"></a>  }</span>
<span id="cb48-138"><a href="rendering.html#cb48-138" tabindex="-1"></a>}</span></code></pre></div>
<p>Since we rely on the <code>xml2</code> package to add in the extra label formatting, let’s import it:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="rendering.html#cb49-1" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_package</span>(<span class="st">"xml2"</span>)</span></code></pre></div>
<pre><code>## ✔ Adding 'xml2' to Imports field in DESCRIPTION
## • Refer to functions with `xml2::fun()`</code></pre>
<p>Finally, we want to replace the ANSI escape sequences used by packages such as <code>testthat</code> and <code>devtools</code> with their HTML equivalents so the output matches what we see in the terminal.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="rendering.html#cb51-1" tabindex="-1"></a><span class="co">#' Replace ANSI escape sequences with their HTML equivalents</span></span>
<span id="cb51-2"><a href="rendering.html#cb51-2" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb51-3"><a href="rendering.html#cb51-3" tabindex="-1"></a><span class="co">#' Finds ANSI escape sequences and replaces them with HTML tags using the `fansi` package</span></span>
<span id="cb51-4"><a href="rendering.html#cb51-4" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb51-5"><a href="rendering.html#cb51-5" tabindex="-1"></a><span class="co">#' @param html_files Character vector of file names of html files that were created</span></span>
<span id="cb51-6"><a href="rendering.html#cb51-6" tabindex="-1"></a><span class="co">#' from Rmd files</span></span>
<span id="cb51-7"><a href="rendering.html#cb51-7" tabindex="-1"></a><span class="co">#' @keywords internal</span></span>
<span id="cb51-8"><a href="rendering.html#cb51-8" tabindex="-1"></a><span id="replace_ansi_sequences">replace_ansi_sequences</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(html_files) {</span>
<span id="cb51-9"><a href="rendering.html#cb51-9" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(html_files)) {</span>
<span id="cb51-10"><a href="rendering.html#cb51-10" tabindex="-1"></a>    file_lines <span class="ot">&lt;-</span> <span class="fu">readLines</span>(html_files[i])</span>
<span id="cb51-11"><a href="rendering.html#cb51-11" tabindex="-1"></a>    <span class="co"># look for lines with escape sequences for URLs and remove the URL</span></span>
<span id="cb51-12"><a href="rendering.html#cb51-12" tabindex="-1"></a>    <span class="co"># escape sequences before we convert to HTML</span></span>
<span id="cb51-13"><a href="rendering.html#cb51-13" tabindex="-1"></a>    url_code_regex <span class="ot">&lt;-</span> <span class="st">"</span><span class="sc">\\</span><span class="st">033]8;;.*</span><span class="sc">\\</span><span class="st">a(.*?)</span><span class="sc">\\</span><span class="st">033]8;;</span><span class="sc">\\</span><span class="st">a"</span></span>
<span id="cb51-14"><a href="rendering.html#cb51-14" tabindex="-1"></a>    url_seq_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(stringr<span class="sc">::</span><span class="fu">str_detect</span>(file_lines, url_code_regex))</span>
<span id="cb51-15"><a href="rendering.html#cb51-15" tabindex="-1"></a>    file_lines[url_seq_idx] <span class="ot">&lt;-</span> <span class="fu">sapply</span>(url_seq_idx, <span class="cf">function</span>(idx){</span>
<span id="cb51-16"><a href="rendering.html#cb51-16" tabindex="-1"></a>      line <span class="ot">&lt;-</span> file_lines[idx]</span>
<span id="cb51-17"><a href="rendering.html#cb51-17" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_replace</span>(line, url_code_regex, stringr<span class="sc">::</span><span class="fu">str_glue</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>))  </span>
<span id="cb51-18"><a href="rendering.html#cb51-18" tabindex="-1"></a>    })</span>
<span id="cb51-19"><a href="rendering.html#cb51-19" tabindex="-1"></a>    </span>
<span id="cb51-20"><a href="rendering.html#cb51-20" tabindex="-1"></a>    txt <span class="ot">&lt;-</span></span>
<span id="cb51-21"><a href="rendering.html#cb51-21" tabindex="-1"></a>      fansi<span class="sc">::</span><span class="fu">sgr_to_html</span>(<span class="at">x =</span> file_lines,</span>
<span id="cb51-22"><a href="rendering.html#cb51-22" tabindex="-1"></a>                         <span class="at">warn =</span> <span class="cn">FALSE</span>,</span>
<span id="cb51-23"><a href="rendering.html#cb51-23" tabindex="-1"></a>                         <span class="at">term.cap =</span> <span class="st">"256"</span>)</span>
<span id="cb51-24"><a href="rendering.html#cb51-24" tabindex="-1"></a>    <span class="fu">writeLines</span>(txt, <span class="at">con =</span> html_files[i])</span>
<span id="cb51-25"><a href="rendering.html#cb51-25" tabindex="-1"></a>  }</span>
<span id="cb51-26"><a href="rendering.html#cb51-26" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="bookdown-output-format" class="section level3 hasAnchor" number="7.1.3">
<h3>
<span class="header-section-number">7.1.3</span> bookdown output format<a href="rendering.html#bookdown-output-format" class="anchor-section" aria-label="Anchor link to header"></a>
</h3>
<p>It turns out that our modification to the <code>bookdown::gitbook()</code> format’s postprocessor is identical to the above. This suggests that we should probably reuse code more effectively. But for now I will leave it how it is:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="rendering.html#cb52-1" tabindex="-1"></a><span class="co">#' litr version of `bookdown::gitbook()`</span></span>
<span id="cb52-2"><a href="rendering.html#cb52-2" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb52-3"><a href="rendering.html#cb52-3" tabindex="-1"></a><span class="co">#' This behaves like `bookdown::gitbook()` with a few differences:</span></span>
<span id="cb52-4"><a href="rendering.html#cb52-4" tabindex="-1"></a><span class="co">#' - It creates an R package.</span></span>
<span id="cb52-5"><a href="rendering.html#cb52-5" tabindex="-1"></a><span class="co">#' - It adds hyperlinks to function definitions whenever a function is used</span></span>
<span id="cb52-6"><a href="rendering.html#cb52-6" tabindex="-1"></a><span class="co">#' elsewhere in the document.</span></span>
<span id="cb52-7"><a href="rendering.html#cb52-7" tabindex="-1"></a><span class="co">#' - It does "Knuth-style" chunk referencing with hyperlinks.</span></span>
<span id="cb52-8"><a href="rendering.html#cb52-8" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb52-9"><a href="rendering.html#cb52-9" tabindex="-1"></a><span class="co">#' @param minimal_eval If `TRUE`, then only chunks with `litr::<a href="document.html#document">document</a>()` or </span></span>
<span id="cb52-10"><a href="rendering.html#cb52-10" tabindex="-1"></a><span class="co">#' `usethis` commands will be evaluated.  This can be convenient in coding when </span></span>
<span id="cb52-11"><a href="rendering.html#cb52-11" tabindex="-1"></a><span class="co">#' you just want to quickly update the R package without having to wait for long</span></span>
<span id="cb52-12"><a href="rendering.html#cb52-12" tabindex="-1"></a><span class="co">#' evaluations to occur.</span></span>
<span id="cb52-13"><a href="rendering.html#cb52-13" tabindex="-1"></a><span class="co">#' @param ... Parameters to be passed to `bookdown::gitbook()` </span></span>
<span id="cb52-14"><a href="rendering.html#cb52-14" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb52-15"><a href="rendering.html#cb52-15" tabindex="-1"></a><span id="litr_gitbook">litr_gitbook</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">minimal_eval =</span> <span class="cn">FALSE</span>, ...) {</span>
<span id="cb52-16"><a href="rendering.html#cb52-16" tabindex="-1"></a>  litr_gitbook_ <span class="ot">&lt;-</span> <a href="rendering.html#litrify_output_format">litrify_output_format</a>(bookdown<span class="sc">::</span>gitbook,</span>
<span id="cb52-17"><a href="rendering.html#cb52-17" tabindex="-1"></a>                                         <span class="at">minimal_eval =</span> minimal_eval)</span>
<span id="cb52-18"><a href="rendering.html#cb52-18" tabindex="-1"></a>  old <span class="ot">&lt;-</span> <span class="fu">litr_gitbook_</span>(...)</span>
<span id="cb52-19"><a href="rendering.html#cb52-19" tabindex="-1"></a>  new <span class="ot">&lt;-</span> old</span>
<span id="cb52-20"><a href="rendering.html#cb52-20" tabindex="-1"></a>  <span class="co"># modify post_processor</span></span>
<span id="cb52-21"><a href="rendering.html#cb52-21" tabindex="-1"></a>  new<span class="sc">$</span>post_processor <span class="ot">=</span> <span class="cf">function</span>(metadata, input_file, output_file, ...) {</span>
<span id="cb52-22"><a href="rendering.html#cb52-22" tabindex="-1"></a>    out <span class="ot">&lt;-</span> old<span class="sc">$</span><a href="rendering.html#post_processor">post_processor</a>(metadata, input_file, output_file, ...)</span>
<span id="cb52-23"><a href="rendering.html#cb52-23" tabindex="-1"></a>    out_dir <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path_dir</span>(out)</span>
<span id="cb52-24"><a href="rendering.html#cb52-24" tabindex="-1"></a>    file_stems <span class="ot">&lt;-</span> <span class="fu">readLines</span>(<span class="fu">file.path</span>(out_dir, <span class="st">"reference-keys.txt"</span>))</span>
<span id="cb52-25"><a href="rendering.html#cb52-25" tabindex="-1"></a>    html_files <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="fu">paste0</span>(file_stems, <span class="st">".html"</span>))</span>
<span id="cb52-26"><a href="rendering.html#cb52-26" tabindex="-1"></a>    html_files <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">intersect</span>(<span class="fu">c</span>(out, html_files), fs<span class="sc">::</span><span class="fu">dir_ls</span>(out_dir)))</span>
<span id="cb52-27"><a href="rendering.html#cb52-27" tabindex="-1"></a>    <span class="co"># add hyperlinks within html output to make it easier to navigate:</span></span>
<span id="cb52-28"><a href="rendering.html#cb52-28" tabindex="-1"></a>    <a href="rendering.html#add_function_hyperlinks">add_function_hyperlinks</a>(html_files, metadata<span class="sc">$</span>params<span class="sc">$</span>package_name)</span>
<span id="cb52-29"><a href="rendering.html#cb52-29" tabindex="-1"></a>    <a href="rendering.html#add_chunk_label_hyperlinks">add_chunk_label_hyperlinks</a>(html_files)</span>
<span id="cb52-30"><a href="rendering.html#cb52-30" tabindex="-1"></a>    <span class="co"># replace ANSI sequences with HTML tag equivalents</span></span>
<span id="cb52-31"><a href="rendering.html#cb52-31" tabindex="-1"></a>    <a href="rendering.html#replace_ansi_sequences">replace_ansi_sequences</a>(html_files)</span>
<span id="cb52-32"><a href="rendering.html#cb52-32" tabindex="-1"></a>    out</span>
<span id="cb52-33"><a href="rendering.html#cb52-33" tabindex="-1"></a>  }</span>
<span id="cb52-34"><a href="rendering.html#cb52-34" tabindex="-1"></a>  new</span>
<span id="cb52-35"><a href="rendering.html#cb52-35" tabindex="-1"></a>}</span></code></pre></div>
<p>To use this output format, one would use <code>bookdown::render_book()</code> instead of <code>rmarkdown::render()</code>. In particular:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="rendering.html#cb53-1" tabindex="-1"></a>bookdown<span class="sc">::</span><span class="fu">render_book</span>(<span class="at">output_format =</span> litr<span class="sc">::</span><a href="rendering.html#litr_gitbook">litr_gitbook</a>())</span></code></pre></div>
<p>The preamble in <code>index.Rmd</code> would look something like this:</p>
<pre><code>---
title: "A `litr` Book"
author: "Your Name"
site: bookdown::bookdown_site
params:
  package_name: "frombookdown" # &lt;-- change this to your package name
  package_parent_dir: "." # &lt;-- relative to this file's location
documentclass: book
---</code></pre>
<p>Or one can add to the preamble the lines</p>
<pre><code>knit: litr::render
output: litr::litr_gitbook</code></pre>
<p>This first line makes it so that in RStudio when you press “Knit”, it calls <code>litr::<a href="rendering.html#render">render</a>()</code>, and the second line makes it so that it will use the special litr bookdown output format.</p>
<p>Since the above function uses <code>bookdown</code>, we include it in our package:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="rendering.html#cb56-1" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_package</span>(<span class="st">"bookdown"</span>)</span></code></pre></div>
<pre><code>## ✔ Adding 'bookdown' to Imports field in DESCRIPTION
## • Refer to functions with `bookdown::fun()`</code></pre>
</div>
</div>
<div id="render" class="section level2 hasAnchor" number="7.2">
<h2>
<span class="header-section-number">7.2</span> Defining <code>litr::<a href="rendering.html#render">render</a>()</code><a href="rendering.html#render" class="anchor-section" aria-label="Anchor link to header"></a>
</h2>
<p>There are two primary use cases for this function:</p>
<ol style="list-style-type: decimal">
<li><p>To render a .Rmd with a non-<code>litr</code> output format (e.g., <code>rmarkdown::html_document</code>) in such a way that it will generate an R package (and include the special litr-hyperlinking if .html files were created).</p></li>
<li><p>To render a .Rmd with a <code>litr</code> output format (including the <code><a href="rendering.html#litr_gitbook">litr_gitbook</a>()</code> format).</p></li>
</ol>
<p>The second use case might seem unnecessary in that</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="rendering.html#cb58-1" tabindex="-1"></a>rmarkdown<span class="sc">::</span><a href="rendering.html#render">render</a>(<span class="st">"create-pkg.Rmd"</span>, <span class="at">output_format =</span> litr<span class="sc">::</span><a href="rendering.html#litr_html_document">litr_html_document</a>())</span></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="rendering.html#cb59-1" tabindex="-1"></a>bookdown<span class="sc">::</span><span class="fu">render_book</span>(<span class="st">"index.Rmd"</span>, <span class="at">output_format =</span> litr<span class="sc">::</span><a href="rendering.html#litr_gitbook">litr_gitbook</a>())</span></code></pre></div>
<p>would do what we want. However, a reason to still prefer <code>litr::<a href="rendering.html#render">render</a>()</code> is that this function ensures the identical behavior to when one clicks the “Knit” in RStudio. It does this by opening a fresh R session (when <code>fresh_session=TRUE</code>, which is the default) in which <code>rmarkdown::render()</code> (or <code>bookdown::render_book()</code>) is called. This is based on <a href="https://bookdown.org/yihui/rmarkdown-cookbook/rmarkdown-render.html">the description in the Rmarkdown Cookbook</a>. Another reason to prefer <code>litr::<a href="rendering.html#render">render</a>()</code> is that if there is an error in the rendering process, the special <a href="hash.html#hash">litr hash</a> will still be written to the DESCRIPTION file. This means that after fixing that error when one calls <code>litr::<a href="rendering.html#render">render</a>()</code>, one will not get the error telling the user to delete the partially generated package directory. We accomplish this with the function <code>with_cleanup()</code> defined below.</p>
<p>In the first use case, <code>litr::<a href="rendering.html#render">render</a>()</code> is responsible for ensuring all the special <code>litr</code> things happen (like <code>setup()</code> being called before knitting, the litr-hash being written afterwards, and hyperlinking occurs). The details of what it does is very similar to what is described in the <a href="hash.html#output-format">output formats</a> section, especially the one on the <a href="rendering.html#html-output-format">html output format</a>.</p>
<p>One thing that is different is that we need a function <code><a href="rendering.html#get_params_used">get_params_used</a>()</code>, defined at the end of this section, that gets the actual parameters that are used so that the location of the outputted package can be found.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="rendering.html#cb60-1" tabindex="-1"></a><span class="co">#' Render R markdown file</span></span>
<span id="cb60-2"><a href="rendering.html#cb60-2" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb60-3"><a href="rendering.html#cb60-3" tabindex="-1"></a><span class="co">#' Wrapper to `rmarkdown::render()` that produces an R package as output in </span></span>
<span id="cb60-4"><a href="rendering.html#cb60-4" tabindex="-1"></a><span class="co">#' addition to the standard output document.  It does some post-processing on the </span></span>
<span id="cb60-5"><a href="rendering.html#cb60-5" tabindex="-1"></a><span class="co">#' .html file when that is the output.  In particular, when an .html file is among</span></span>
<span id="cb60-6"><a href="rendering.html#cb60-6" tabindex="-1"></a><span class="co">#' the outputs, it adds hyperlinks to functions defined within the file to make </span></span>
<span id="cb60-7"><a href="rendering.html#cb60-7" tabindex="-1"></a><span class="co">#' it easier for someone reading the code to see where different functions are</span></span>
<span id="cb60-8"><a href="rendering.html#cb60-8" tabindex="-1"></a><span class="co">#' defined.</span></span>
<span id="cb60-9"><a href="rendering.html#cb60-9" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb60-10"><a href="rendering.html#cb60-10" tabindex="-1"></a><span class="co">#' @param input The input file to be rendered (see `rmarkdown::render`)</span></span>
<span id="cb60-11"><a href="rendering.html#cb60-11" tabindex="-1"></a><span class="co">#' @param minimal_eval If `TRUE`, then only chunks with `litr::<a href="document.html#document">document</a>()` or </span></span>
<span id="cb60-12"><a href="rendering.html#cb60-12" tabindex="-1"></a><span class="co">#' `usethis` commands will be evaluated.  This can be convenient in coding when </span></span>
<span id="cb60-13"><a href="rendering.html#cb60-13" tabindex="-1"></a><span class="co">#' you just want to quickly update the R package without having to wait for long</span></span>
<span id="cb60-14"><a href="rendering.html#cb60-14" tabindex="-1"></a><span class="co">#' evaluations to occur.</span></span>
<span id="cb60-15"><a href="rendering.html#cb60-15" tabindex="-1"></a><span class="co">#' @param fresh_session Whether to call `rmarkdown::render` from a fresh R </span></span>
<span id="cb60-16"><a href="rendering.html#cb60-16" tabindex="-1"></a><span class="co">#' session. By default TRUE, so that it matches the behavior of pressing "Knitr"</span></span>
<span id="cb60-17"><a href="rendering.html#cb60-17" tabindex="-1"></a><span class="co">#' in RStudio.  However, for debugging it can be useful to set this to FALSE so </span></span>
<span id="cb60-18"><a href="rendering.html#cb60-18" tabindex="-1"></a><span class="co">#' that functions like `debug()` and `browser()` will work.</span></span>
<span id="cb60-19"><a href="rendering.html#cb60-19" tabindex="-1"></a><span class="co">#' @param ... Additional parameters to pass to `rmarkdown::render`</span></span>
<span id="cb60-20"><a href="rendering.html#cb60-20" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb60-21"><a href="rendering.html#cb60-21" tabindex="-1"></a><span id="render">render</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(input, minimal_eval, <span class="at">fresh_session =</span> <span class="cn">TRUE</span>, ...) {</span>
<span id="cb60-22"><a href="rendering.html#cb60-22" tabindex="-1"></a>  <span class="co"># call rmarkdown::render in a new environment so it behaves the same as </span></span>
<span id="cb60-23"><a href="rendering.html#cb60-23" tabindex="-1"></a>  <span class="co"># pressing the knit button in RStudio:</span></span>
<span id="cb60-24"><a href="rendering.html#cb60-24" tabindex="-1"></a>  <span class="co"># https://bookdown.org/yihui/rmarkdown-cookbook/rmarkdown-render.html</span></span>
<span id="cb60-25"><a href="rendering.html#cb60-25" tabindex="-1"></a>  args <span class="ot">&lt;-</span> <span class="fu">list</span>(...)</span>
<span id="cb60-26"><a href="rendering.html#cb60-26" tabindex="-1"></a></span>
<span id="cb60-27"><a href="rendering.html#cb60-27" tabindex="-1"></a>  <span class="co"># let's determine if the output format being used is a litr format.</span></span>
<span id="cb60-28"><a href="rendering.html#cb60-28" tabindex="-1"></a>  <span class="co"># If it is, then we'll simply want to call rmarkdown::render() since the </span></span>
<span id="cb60-29"><a href="rendering.html#cb60-29" tabindex="-1"></a>  <span class="co"># special litr behavior will be attained through the output format.</span></span>
<span id="cb60-30"><a href="rendering.html#cb60-30" tabindex="-1"></a>  litr_format <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb60-31"><a href="rendering.html#cb60-31" tabindex="-1"></a>  bookdown_format <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb60-32"><a href="rendering.html#cb60-32" tabindex="-1"></a>  output_format_arg <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb60-33"><a href="rendering.html#cb60-33" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"output_format"</span> <span class="sc">%in%</span> <span class="fu">names</span>(args)) {</span>
<span id="cb60-34"><a href="rendering.html#cb60-34" tabindex="-1"></a>    output_format_arg <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb60-35"><a href="rendering.html#cb60-35" tabindex="-1"></a>    <span class="cf">if</span> (<span class="st">"litr_format"</span> <span class="sc">%in%</span> <span class="fu">names</span>(args<span class="sc">$</span>output_format)) {</span>
<span id="cb60-36"><a href="rendering.html#cb60-36" tabindex="-1"></a>      litr_format <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb60-37"><a href="rendering.html#cb60-37" tabindex="-1"></a>    }</span>
<span id="cb60-38"><a href="rendering.html#cb60-38" tabindex="-1"></a>    <span class="cf">if</span> (<span class="st">"bookdown_output_format"</span> <span class="sc">%in%</span> <span class="fu">names</span>(args<span class="sc">$</span>output_format)) {</span>
<span id="cb60-39"><a href="rendering.html#cb60-39" tabindex="-1"></a>      bookdown_format <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb60-40"><a href="rendering.html#cb60-40" tabindex="-1"></a>    }</span>
<span id="cb60-41"><a href="rendering.html#cb60-41" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb60-42"><a href="rendering.html#cb60-42" tabindex="-1"></a>    frontmatter <span class="ot">&lt;-</span> rmarkdown<span class="sc">::</span><span class="fu">yaml_front_matter</span>(input)</span>
<span id="cb60-43"><a href="rendering.html#cb60-43" tabindex="-1"></a>    <span class="cf">if</span> (<span class="st">"output"</span> <span class="sc">%in%</span> <span class="fu">names</span>(frontmatter)) {</span>
<span id="cb60-44"><a href="rendering.html#cb60-44" tabindex="-1"></a>      formats <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.list</span>(frontmatter<span class="sc">$</span>output),</span>
<span id="cb60-45"><a href="rendering.html#cb60-45" tabindex="-1"></a>                        <span class="fu">names</span>(frontmatter<span class="sc">$</span>output),</span>
<span id="cb60-46"><a href="rendering.html#cb60-46" tabindex="-1"></a>                        frontmatter<span class="sc">$</span>output)</span>
<span id="cb60-47"><a href="rendering.html#cb60-47" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">any</span>(stringr<span class="sc">::</span><span class="fu">str_detect</span>(formats, <span class="st">"litr::"</span>))) {</span>
<span id="cb60-48"><a href="rendering.html#cb60-48" tabindex="-1"></a>        litr_format <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb60-49"><a href="rendering.html#cb60-49" tabindex="-1"></a>      }</span>
<span id="cb60-50"><a href="rendering.html#cb60-50" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">any</span>(stringr<span class="sc">::</span><span class="fu">str_detect</span>(formats, <span class="st">"litr::litr_gitbook"</span>))) {</span>
<span id="cb60-51"><a href="rendering.html#cb60-51" tabindex="-1"></a>        bookdown_format <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb60-52"><a href="rendering.html#cb60-52" tabindex="-1"></a>      }</span>
<span id="cb60-53"><a href="rendering.html#cb60-53" tabindex="-1"></a>    }</span>
<span id="cb60-54"><a href="rendering.html#cb60-54" tabindex="-1"></a>  }</span>
<span id="cb60-55"><a href="rendering.html#cb60-55" tabindex="-1"></a></span>
<span id="cb60-56"><a href="rendering.html#cb60-56" tabindex="-1"></a>  <span class="co"># get package_directory</span></span>
<span id="cb60-57"><a href="rendering.html#cb60-57" tabindex="-1"></a>  params <span class="ot">&lt;-</span> <a href="rendering.html#get_params_used">get_params_used</a>(input, args<span class="sc">$</span>params)</span>
<span id="cb60-58"><a href="rendering.html#cb60-58" tabindex="-1"></a>  package_dir <span class="ot">&lt;-</span> <a href="rendering.html#get_package_directory">get_package_directory</a>(</span>
<span id="cb60-59"><a href="rendering.html#cb60-59" tabindex="-1"></a>    params<span class="sc">$</span>package_parent_dir,</span>
<span id="cb60-60"><a href="rendering.html#cb60-60" tabindex="-1"></a>    params<span class="sc">$</span>package_name,</span>
<span id="cb60-61"><a href="rendering.html#cb60-61" tabindex="-1"></a>    input</span>
<span id="cb60-62"><a href="rendering.html#cb60-62" tabindex="-1"></a>    )</span>
<span id="cb60-63"><a href="rendering.html#cb60-63" tabindex="-1"></a>  </span>
<span id="cb60-64"><a href="rendering.html#cb60-64" tabindex="-1"></a>  <span class="co"># if minimal_eval was passed to render, add this to the output_options</span></span>
<span id="cb60-65"><a href="rendering.html#cb60-65" tabindex="-1"></a>  <span class="co"># argument that will be passed to rmarkdown::render</span></span>
<span id="cb60-66"><a href="rendering.html#cb60-66" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(args<span class="sc">$</span>output_options)) args<span class="sc">$</span>output_options <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb60-67"><a href="rendering.html#cb60-67" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">missing</span>(minimal_eval)) args<span class="sc">$</span>output_options<span class="sc">$</span>minimal_eval <span class="ot">&lt;-</span> minimal_eval</span>
<span id="cb60-68"><a href="rendering.html#cb60-68" tabindex="-1"></a>  </span>
<span id="cb60-69"><a href="rendering.html#cb60-69" tabindex="-1"></a>  <span class="co"># determine whether a new R session will be created when we run the rendering </span></span>
<span id="cb60-70"><a href="rendering.html#cb60-70" tabindex="-1"></a>  <span class="co"># function of rmarkdown/bookdown</span></span>
<span id="cb60-71"><a href="rendering.html#cb60-71" tabindex="-1"></a>  <span class="cf">if</span> (fresh_session)</span>
<span id="cb60-72"><a href="rendering.html#cb60-72" tabindex="-1"></a>    run_function <span class="ot">&lt;-</span> xfun<span class="sc">::</span>Rscript_call</span>
<span id="cb60-73"><a href="rendering.html#cb60-73" tabindex="-1"></a>  <span class="cf">else</span></span>
<span id="cb60-74"><a href="rendering.html#cb60-74" tabindex="-1"></a>    run_function <span class="ot">&lt;-</span> do.call</span>
<span id="cb60-75"><a href="rendering.html#cb60-75" tabindex="-1"></a>  </span>
<span id="cb60-76"><a href="rendering.html#cb60-76" tabindex="-1"></a>  <span class="cf">if</span> (litr_format) {</span>
<span id="cb60-77"><a href="rendering.html#cb60-77" tabindex="-1"></a>    <span class="co"># this uses a litr output format, so we don't need to do anything litr-specific</span></span>
<span id="cb60-78"><a href="rendering.html#cb60-78" tabindex="-1"></a>    <span class="co"># here because it will happen through the output format</span></span>
<span id="cb60-79"><a href="rendering.html#cb60-79" tabindex="-1"></a>    </span>
<span id="cb60-80"><a href="rendering.html#cb60-80" tabindex="-1"></a>    <span class="cf">if</span> (output_format_arg <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">missing</span>(minimal_eval)) {</span>
<span id="cb60-81"><a href="rendering.html#cb60-81" tabindex="-1"></a>      <span class="co"># the output format was passed through the output_format argument rather </span></span>
<span id="cb60-82"><a href="rendering.html#cb60-82" tabindex="-1"></a>      <span class="co"># than through the metadata</span></span>
<span id="cb60-83"><a href="rendering.html#cb60-83" tabindex="-1"></a>      <span class="cf">if</span> (minimal_eval) {</span>
<span id="cb60-84"><a href="rendering.html#cb60-84" tabindex="-1"></a>        <span class="fu">stop</span>(<a href="generating-package.html#make_noticeable">make_noticeable</a>(<span class="fu">paste</span>(</span>
<span id="cb60-85"><a href="rendering.html#cb60-85" tabindex="-1"></a>          <span class="st">"When passing a litr output format using the output_format argument,"</span>,</span>
<span id="cb60-86"><a href="rendering.html#cb60-86" tabindex="-1"></a>          <span class="st">"you should not pass minimal_eval = TRUE directly to render."</span>,</span>
<span id="cb60-87"><a href="rendering.html#cb60-87" tabindex="-1"></a>          <span class="st">"Instead, pass it to the litr output format function.  For example,"</span>,</span>
<span id="cb60-88"><a href="rendering.html#cb60-88" tabindex="-1"></a>          <span class="st">"litr::<a href="rendering.html#litr_html_document">litr_html_document</a>(minimal_eval = TRUE)."</span>,</span>
<span id="cb60-89"><a href="rendering.html#cb60-89" tabindex="-1"></a>          <span class="at">collapse =</span> <span class="st">" "</span></span>
<span id="cb60-90"><a href="rendering.html#cb60-90" tabindex="-1"></a>          )))</span>
<span id="cb60-91"><a href="rendering.html#cb60-91" tabindex="-1"></a>      }</span>
<span id="cb60-92"><a href="rendering.html#cb60-92" tabindex="-1"></a>    }</span>
<span id="cb60-93"><a href="rendering.html#cb60-93" tabindex="-1"></a>    </span>
<span id="cb60-94"><a href="rendering.html#cb60-94" tabindex="-1"></a>    <span class="cf">if</span> (bookdown_format) {</span>
<span id="cb60-95"><a href="rendering.html#cb60-95" tabindex="-1"></a>      <span class="cf">if</span> (fs<span class="sc">::</span><span class="fu">is_file</span>(input)) input <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path_dir</span>(input)</span>
<span id="cb60-96"><a href="rendering.html#cb60-96" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="fu">run_function</span>(<a href="rendering.html#with_cleanup">with_cleanup</a>(bookdown<span class="sc">::</span>render_book,</span>
<span id="cb60-97"><a href="rendering.html#cb60-97" tabindex="-1"></a>                                                 package_dir),</span>
<span id="cb60-98"><a href="rendering.html#cb60-98" tabindex="-1"></a>                                    <span class="fu">c</span>(<span class="at">input =</span> input, args))))</span>
<span id="cb60-99"><a href="rendering.html#cb60-99" tabindex="-1"></a>    }</span>
<span id="cb60-100"><a href="rendering.html#cb60-100" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb60-101"><a href="rendering.html#cb60-101" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="fu">run_function</span>(<a href="rendering.html#with_cleanup">with_cleanup</a>(rmarkdown<span class="sc">::</span>render,</span>
<span id="cb60-102"><a href="rendering.html#cb60-102" tabindex="-1"></a>                                                 package_dir),</span>
<span id="cb60-103"><a href="rendering.html#cb60-103" tabindex="-1"></a>                                    <span class="fu">c</span>(<span class="at">input =</span> input, args))))</span>
<span id="cb60-104"><a href="rendering.html#cb60-104" tabindex="-1"></a>  }</span>
<span id="cb60-105"><a href="rendering.html#cb60-105" tabindex="-1"></a>  </span>
<span id="cb60-106"><a href="rendering.html#cb60-106" tabindex="-1"></a>  <span class="co"># the output format being used is not a litr-specific one, so we need to make</span></span>
<span id="cb60-107"><a href="rendering.html#cb60-107" tabindex="-1"></a>  <span class="co"># sure that all the special litr things happen</span></span>
<span id="cb60-108"><a href="rendering.html#cb60-108" tabindex="-1"></a>  args<span class="sc">$</span>package_dir <span class="ot">&lt;-</span> package_dir</span>
<span id="cb60-109"><a href="rendering.html#cb60-109" tabindex="-1"></a></span>
<span id="cb60-110"><a href="rendering.html#cb60-110" tabindex="-1"></a>  <span id="render_">render_</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(input, package_dir, minimal_eval, ...) {</span>
<span id="cb60-111"><a href="rendering.html#cb60-111" tabindex="-1"></a>    knitr_objects <span class="ot">&lt;-</span> litr<span class="sc">:::</span><a href="generating-package.html#setup">setup</a>(package_dir, minimal_eval)</span>
<span id="cb60-112"><a href="rendering.html#cb60-112" tabindex="-1"></a>    out <span class="ot">&lt;-</span> rmarkdown<span class="sc">::</span><a href="rendering.html#render">render</a>(input, ...)</span>
<span id="cb60-113"><a href="rendering.html#cb60-113" tabindex="-1"></a>    <a href="rendering.html#restore_knitr_objects">restore_knitr_objects</a>(knitr_objects)</span>
<span id="cb60-114"><a href="rendering.html#cb60-114" tabindex="-1"></a>    <span class="co"># remove .Rproj and .gitignore if usethis::create_package() added these</span></span>
<span id="cb60-115"><a href="rendering.html#cb60-115" tabindex="-1"></a>    <a href="rendering.html#remove_rstudio_extras">remove_rstudio_extras</a>(package_dir)</span>
<span id="cb60-116"><a href="rendering.html#cb60-116" tabindex="-1"></a>    <span class="fu">return</span>(out)</span>
<span id="cb60-117"><a href="rendering.html#cb60-117" tabindex="-1"></a>  }</span>
<span id="cb60-118"><a href="rendering.html#cb60-118" tabindex="-1"></a></span>
<span id="cb60-119"><a href="rendering.html#cb60-119" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">missing</span>(minimal_eval)) minimal_eval <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb60-120"><a href="rendering.html#cb60-120" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">run_function</span>(<a href="rendering.html#with_cleanup">with_cleanup</a>(render_, package_dir),</span>
<span id="cb60-121"><a href="rendering.html#cb60-121" tabindex="-1"></a>                      <span class="fu">c</span>(<span class="at">input =</span> input, <span class="at">minimal_eval =</span> minimal_eval, args))</span>
<span id="cb60-122"><a href="rendering.html#cb60-122" tabindex="-1"></a></span>
<span id="cb60-123"><a href="rendering.html#cb60-123" tabindex="-1"></a></span>
<span id="cb60-124"><a href="rendering.html#cb60-124" tabindex="-1"></a>  <span class="co"># add hyperlinks within html output to make it easier to navigate:</span></span>
<span id="cb60-125"><a href="rendering.html#cb60-125" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(stringr<span class="sc">::</span><span class="fu">str_detect</span>(out, <span class="st">"html$"</span>))) {</span>
<span id="cb60-126"><a href="rendering.html#cb60-126" tabindex="-1"></a>    html_file <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_subset</span>(out, <span class="st">"html$"</span>)</span>
<span id="cb60-127"><a href="rendering.html#cb60-127" tabindex="-1"></a>    <a href="rendering.html#add_function_hyperlinks">add_function_hyperlinks</a>(html_file, params<span class="sc">$</span>package_name)</span>
<span id="cb60-128"><a href="rendering.html#cb60-128" tabindex="-1"></a>    <a href="rendering.html#add_chunk_label_hyperlinks">add_chunk_label_hyperlinks</a>(html_file)</span>
<span id="cb60-129"><a href="rendering.html#cb60-129" tabindex="-1"></a>  }</span>
<span id="cb60-130"><a href="rendering.html#cb60-130" tabindex="-1"></a>  </span>
<span id="cb60-131"><a href="rendering.html#cb60-131" tabindex="-1"></a>  <span class="co"># add to DESCRIPTION file the version of litr used to create package:</span></span>
<span id="cb60-132"><a href="rendering.html#cb60-132" tabindex="-1"></a>  <a href="rendering.html#write_version_to_description">write_version_to_description</a>(package_dir)</span>
<span id="cb60-133"><a href="rendering.html#cb60-133" tabindex="-1"></a>  </span>
<span id="cb60-134"><a href="rendering.html#cb60-134" tabindex="-1"></a>  <span class="co"># add litr hash so we can tell later if package files were manually edited:</span></span>
<span id="cb60-135"><a href="rendering.html#cb60-135" tabindex="-1"></a>  <a href="hash.html#write_hash_to_description">write_hash_to_description</a>(package_dir)</span>
<span id="cb60-136"><a href="rendering.html#cb60-136" tabindex="-1"></a>}</span></code></pre></div>
<p>We used the package <code>xfun</code>, so let’s import it:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="rendering.html#cb61-1" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_package</span>(<span class="st">"xfun"</span>)</span></code></pre></div>
<pre><code>## ✔ Adding 'xfun' to Imports field in DESCRIPTION
## • Refer to functions with `xfun::fun()`</code></pre>
<p>When <code>litr::<a href="rendering.html#render">render</a>()</code> encounters an error, it can leave the output directory partially modified. We want to make sure the <code>litr</code> hash still gets written to the DESCRIPTION file. Otherwise, the next time one calls <code>litr::<a href="rendering.html#render">render</a>()</code> it does not allow this directory to be overwritten. We do this by using <code>withCallingHandlers()</code>. This function, explained <a href="http://adv-r.had.co.nz/Exceptions-Debugging.html">here</a>, is similar to <code>tryCatch()</code>, but with the advantage that it lets the function to continue to run normally, meaning that we will still get the error message as it would appear if we hadn’t done the condition handling.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="rendering.html#cb63-1" tabindex="-1"></a><span class="co">#' Add litr hash to DESCRIPTION file if error encountered</span></span>
<span id="cb63-2"><a href="rendering.html#cb63-2" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb63-3"><a href="rendering.html#cb63-3" tabindex="-1"></a><span class="co">#' This creates a function that calls the passed function within the context of</span></span>
<span id="cb63-4"><a href="rendering.html#cb63-4" tabindex="-1"></a><span class="co">#' a try-catch.  If an error is encountered, the litr hash is still added to</span></span>
<span id="cb63-5"><a href="rendering.html#cb63-5" tabindex="-1"></a><span class="co">#' the DESCRIPTION file so that future calls to `litr::<a href="rendering.html#render">render</a>()` will recognize</span></span>
<span id="cb63-6"><a href="rendering.html#cb63-6" tabindex="-1"></a><span class="co">#' that it can safely overwrite the package directory (i.e., no manual editing</span></span>
<span id="cb63-7"><a href="rendering.html#cb63-7" tabindex="-1"></a><span class="co">#' occurred).</span></span>
<span id="cb63-8"><a href="rendering.html#cb63-8" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb63-9"><a href="rendering.html#cb63-9" tabindex="-1"></a><span class="co">#' @param fun function being called</span></span>
<span id="cb63-10"><a href="rendering.html#cb63-10" tabindex="-1"></a><span class="co">#' @param package_dir directory where package is being written to</span></span>
<span id="cb63-11"><a href="rendering.html#cb63-11" tabindex="-1"></a><span class="co">#' @param ... arguments to be passed to `fun`</span></span>
<span id="cb63-12"><a href="rendering.html#cb63-12" tabindex="-1"></a><span class="co">#' @keywords internal</span></span>
<span id="cb63-13"><a href="rendering.html#cb63-13" tabindex="-1"></a><span id="with_cleanup">with_cleanup</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(fun, package_dir) {</span>
<span id="cb63-14"><a href="rendering.html#cb63-14" tabindex="-1"></a>  <span class="fu">return</span>(<span class="cf">function</span>(...) {</span>
<span id="cb63-15"><a href="rendering.html#cb63-15" tabindex="-1"></a>    <span class="fu">withCallingHandlers</span>(</span>
<span id="cb63-16"><a href="rendering.html#cb63-16" tabindex="-1"></a>      <span class="fu">fun</span>(...),</span>
<span id="cb63-17"><a href="rendering.html#cb63-17" tabindex="-1"></a>      <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb63-18"><a href="rendering.html#cb63-18" tabindex="-1"></a>        <span class="co"># add litr hash so we can tell later if package files were manually edited:</span></span>
<span id="cb63-19"><a href="rendering.html#cb63-19" tabindex="-1"></a>        <a href="hash.html#write_hash_to_description">write_hash_to_description</a>(package_dir)</span>
<span id="cb63-20"><a href="rendering.html#cb63-20" tabindex="-1"></a>      })</span>
<span id="cb63-21"><a href="rendering.html#cb63-21" tabindex="-1"></a>  })</span>
<span id="cb63-22"><a href="rendering.html#cb63-22" tabindex="-1"></a>}</span></code></pre></div>
<p>In <code><a href="generating-package.html#setup">setup</a>()</code>, we modified the knitr objects (e.g., adding hooks, engines, etc.). We call the function <code><a href="rendering.html#restore_knitr_objects">restore_knitr_objects</a>()</code> after we’re done, to put things back how they were:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="rendering.html#cb64-1" tabindex="-1"></a><span class="co">#' Return the knitr objects to their original state</span></span>
<span id="cb64-2"><a href="rendering.html#cb64-2" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb64-3"><a href="rendering.html#cb64-3" tabindex="-1"></a><span class="co">#' @param original_knitr_objects As returned by `<a href="generating-package.html#setup">setup</a>()`</span></span>
<span id="cb64-4"><a href="rendering.html#cb64-4" tabindex="-1"></a><span class="co">#' @keywords internal</span></span>
<span id="cb64-5"><a href="rendering.html#cb64-5" tabindex="-1"></a><span id="restore_knitr_objects">restore_knitr_objects</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(original_knitr_objects) {</span>
<span id="cb64-6"><a href="rendering.html#cb64-6" tabindex="-1"></a>  knitr<span class="sc">::</span>opts_knit<span class="sc">$</span><span class="fu">restore</span>(original_knitr_objects<span class="sc">$</span>opts_knit)</span>
<span id="cb64-7"><a href="rendering.html#cb64-7" tabindex="-1"></a>  knitr<span class="sc">::</span>knit_hooks<span class="sc">$</span><span class="fu">restore</span>(original_knitr_objects<span class="sc">$</span>knit_hooks)</span>
<span id="cb64-8"><a href="rendering.html#cb64-8" tabindex="-1"></a>  knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">restore</span>(original_knitr_objects<span class="sc">$</span>opts_chunk)</span>
<span id="cb64-9"><a href="rendering.html#cb64-9" tabindex="-1"></a>  knitr<span class="sc">::</span>opts_hooks<span class="sc">$</span><span class="fu">restore</span>(original_knitr_objects<span class="sc">$</span>opts_hooks)</span>
<span id="cb64-10"><a href="rendering.html#cb64-10" tabindex="-1"></a>  knitr<span class="sc">::</span>knit_engines<span class="sc">$</span><span class="fu">restore</span>(original_knitr_objects<span class="sc">$</span>knit_engines)</span>
<span id="cb64-11"><a href="rendering.html#cb64-11" tabindex="-1"></a>}</span></code></pre></div>
<p>Another thing we want to do at the end of the rendering process is to remove two files that might have been created by usethis: .Rproj and .gitignore. These are created by <code>usethis::create_package()</code> when <code>rstudio = TRUE</code>. We don’t want these files created since this would suggest to a user that the R package should be worked on from within it rather than from the generating .Rmd file.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="rendering.html#cb65-1" tabindex="-1"></a><span class="co">#' Remove extra files added by usethis</span></span>
<span id="cb65-2"><a href="rendering.html#cb65-2" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb65-3"><a href="rendering.html#cb65-3" tabindex="-1"></a><span class="co">#' Remove .Rproj and .gitignore files if they are in the package directory.</span></span>
<span id="cb65-4"><a href="rendering.html#cb65-4" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb65-5"><a href="rendering.html#cb65-5" tabindex="-1"></a><span class="co">#' @param package_dir Path to package</span></span>
<span id="cb65-6"><a href="rendering.html#cb65-6" tabindex="-1"></a><span class="co">#' @keywords internal</span></span>
<span id="cb65-7"><a href="rendering.html#cb65-7" tabindex="-1"></a><span id="remove_rstudio_extras">remove_rstudio_extras</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(package_dir) {</span>
<span id="cb65-8"><a href="rendering.html#cb65-8" tabindex="-1"></a>  extras <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">dir_ls</span>(package_dir,</span>
<span id="cb65-9"><a href="rendering.html#cb65-9" tabindex="-1"></a>                       <span class="at">all =</span> <span class="cn">TRUE</span>,</span>
<span id="cb65-10"><a href="rendering.html#cb65-10" tabindex="-1"></a>                       <span class="at">regexp =</span> <span class="st">"[.]Rproj$|[.]gitignore$"</span>)</span>
<span id="cb65-11"><a href="rendering.html#cb65-11" tabindex="-1"></a>  rbuildignore <span class="ot">&lt;-</span> <span class="fu">file.path</span>(package_dir, <span class="st">".Rbuildignore"</span>)</span>
<span id="cb65-12"><a href="rendering.html#cb65-12" tabindex="-1"></a>  txt <span class="ot">&lt;-</span> <span class="fu">readLines</span>(rbuildignore)</span>
<span id="cb65-13"><a href="rendering.html#cb65-13" tabindex="-1"></a>  txt <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_subset</span>(txt, <span class="st">"^.*Rproj.*$"</span>, <span class="at">negate =</span> <span class="cn">TRUE</span>)</span>
<span id="cb65-14"><a href="rendering.html#cb65-14" tabindex="-1"></a>  <span class="fu">writeLines</span>(txt, <span class="at">con =</span> rbuildignore)</span>
<span id="cb65-15"><a href="rendering.html#cb65-15" tabindex="-1"></a>  <span class="cf">for</span> (extra <span class="cf">in</span> extras) fs<span class="sc">::</span><span class="fu">file_delete</span>(extra)</span>
<span id="cb65-16"><a href="rendering.html#cb65-16" tabindex="-1"></a>}</span></code></pre></div>
<p>As described earlier, the function <code><a href="rendering.html#get_params_used">get_params_used</a>()</code> combines the parameters from the YAML but allows for those values to be overridden through arguments passed to <code><a href="rendering.html#render">render</a>()</code>.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="rendering.html#cb66-1" tabindex="-1"></a><span class="co">#' Get parameter values used in rendering</span></span>
<span id="cb66-2"><a href="rendering.html#cb66-2" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb66-3"><a href="rendering.html#cb66-3" tabindex="-1"></a><span class="co">#' When the `params` argument of `rmarkdown::render()` is explicitly used, this</span></span>
<span id="cb66-4"><a href="rendering.html#cb66-4" tabindex="-1"></a><span class="co">#' overrides the default that appears in `input`.</span></span>
<span id="cb66-5"><a href="rendering.html#cb66-5" tabindex="-1"></a><span class="co">#' @param input The input file to be rendered (see `rmarkdown::render`)</span></span>
<span id="cb66-6"><a href="rendering.html#cb66-6" tabindex="-1"></a><span class="co">#' @param passed_params The list of parameters that were passed to `render`.</span></span>
<span id="cb66-7"><a href="rendering.html#cb66-7" tabindex="-1"></a><span class="co">#' @keywords internal</span></span>
<span id="cb66-8"><a href="rendering.html#cb66-8" tabindex="-1"></a><span id="get_params_used">get_params_used</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(input, passed_params) {</span>
<span id="cb66-9"><a href="rendering.html#cb66-9" tabindex="-1"></a>  params <span class="ot">&lt;-</span> rmarkdown<span class="sc">::</span><span class="fu">yaml_front_matter</span>(input)<span class="sc">$</span>params</span>
<span id="cb66-10"><a href="rendering.html#cb66-10" tabindex="-1"></a>  <span class="cf">for</span> (param <span class="cf">in</span> <span class="fu">names</span>(passed_params)) {</span>
<span id="cb66-11"><a href="rendering.html#cb66-11" tabindex="-1"></a>    params[[param]] <span class="ot">&lt;-</span> passed_params[[param]]</span>
<span id="cb66-12"><a href="rendering.html#cb66-12" tabindex="-1"></a>  }</span>
<span id="cb66-13"><a href="rendering.html#cb66-13" tabindex="-1"></a>  params</span>
<span id="cb66-14"><a href="rendering.html#cb66-14" tabindex="-1"></a>}</span></code></pre></div>
<p>We used the package <code>rmarkdown</code>, so let’s import it:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="rendering.html#cb67-1" tabindex="-1"></a>usethis<span class="sc">::</span><span class="fu">use_package</span>(<span class="st">"rmarkdown"</span>)</span></code></pre></div>
<pre><code>## ✔ Adding 'rmarkdown' to Imports field in DESCRIPTION
## • Refer to functions with `rmarkdown::fun()`</code></pre>
</div>
</div>
<div class="footnotes">
<hr>
<ol start="1">
<li id="fn1"><p>For example, we include the line <code>knit: litr::render</code> in the yaml of the templates for this reason.<a href="rendering.html#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>
</div>
        </div>
      </div>
<a href="document.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="functionality-to-facilitate-workflow.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script><script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script><script src="libs/gitbook-2.6.7/js/plugin-search.js"></script><script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script><script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script><script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script><script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script><script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script><script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
